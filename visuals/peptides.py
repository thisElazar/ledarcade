"""
Peptides Visual - Bead-on-Chain 3D Model + Calculator Info Panel
================================================================
Rotating 3D bead-on-chain model (upper region) with an informative
calculator-style info panel (bottom region). Each amino acid is rendered
as a colored shaded sphere connected by backbone bonds, with disulfide
bridges and cyclic closure where applicable.

Controls:
  Joystick  - Manual 3D rotation
  Z / X     - Cycle peptides
  Z+X       - Cycle color mode
"""

import math
from . import Visual, Display, Colors, GRID_SIZE

# =============================================================================
# AMINO ACID DATA TABLES
# =============================================================================

# Molecular weights of amino acids (monoisotopic average, Da)
AA_MW = {
    'G':  57.02, 'A':  71.04, 'V':  99.07, 'L': 113.08, 'I': 113.08,
    'P':  97.05, 'F': 147.07, 'W': 186.08, 'M': 131.04, 'S':  87.03,
    'T': 101.05, 'C': 103.01, 'Y': 163.06, 'H': 137.06, 'D': 115.03,
    'E': 129.04, 'N': 114.04, 'Q': 128.06, 'K': 128.09, 'R': 156.10,
}

# pKa values for ionizable groups
PKA_NTERM = 9.69
PKA_CTERM = 2.34
PKA_SIDE = {
    'C': 8.33, 'D': 3.65, 'E': 4.25, 'H': 6.00, 'K': 10.53, 'R': 12.48,
    'Y': 10.07,
}

# Kyte-Doolittle hydropathy index
HYDROPATHY = {
    'I':  4.5, 'V':  4.2, 'L':  3.8, 'F':  2.8, 'C':  2.5,
    'M':  1.9, 'A':  1.8, 'G': -0.4, 'T': -0.7, 'S': -0.8,
    'W': -0.9, 'Y': -1.3, 'P': -1.6, 'H': -3.2, 'D': -3.5,
    'E': -3.5, 'N': -3.5, 'Q': -3.5, 'K': -3.9, 'R': -4.5,
}

# Amino acid classification for PROPERTY color mode
AA_CLASS = {
    'A': 'hydrophobic', 'V': 'hydrophobic', 'I': 'hydrophobic',
    'L': 'hydrophobic', 'M': 'hydrophobic', 'F': 'hydrophobic',
    'W': 'hydrophobic',
    'S': 'polar', 'T': 'polar', 'N': 'polar', 'Q': 'polar', 'Y': 'polar',
    'C': 'special',
    'G': 'special', 'P': 'special',
    'K': 'positive', 'R': 'positive', 'H': 'positive',
    'D': 'negative', 'E': 'negative',
}

# Colors for each classification
CLASS_COLORS = {
    'hydrophobic': (210, 170, 40),   # Gold
    'polar':       ( 50, 200, 80),   # Green
    'positive':    ( 60, 120, 255),  # Blue
    'negative':    (255,  60, 60),   # Red
    'special':     (180, 80, 220),   # Purple
}

# Single-letter to three-letter codes (for display)
AA_3LETTER = {
    'G': 'GLY', 'A': 'ALA', 'V': 'VAL', 'L': 'LEU', 'I': 'ILE',
    'P': 'PRO', 'F': 'PHE', 'W': 'TRP', 'M': 'MET', 'S': 'SER',
    'T': 'THR', 'C': 'CYS', 'Y': 'TYR', 'H': 'HIS', 'D': 'ASP',
    'E': 'GLU', 'N': 'ASN', 'Q': 'GLN', 'K': 'LYS', 'R': 'ARG',
}

# =============================================================================
# CALCULATOR FUNCTIONS
# =============================================================================

WATER_MW = 18.015

def compute_mw(sequence):
    """Molecular weight from amino acid sequence (sum of residues + water)."""
    return sum(AA_MW.get(aa, 0.0) for aa in sequence) + WATER_MW

def _charge_at_ph(sequence, ph):
    """Net charge at a given pH using Henderson-Hasselbalch."""
    charge = 0.0
    # N-terminus (positive when protonated)
    charge += 1.0 / (1.0 + 10 ** (ph - PKA_NTERM))
    # C-terminus (negative when deprotonated)
    charge -= 1.0 / (1.0 + 10 ** (PKA_CTERM - ph))
    for aa in sequence:
        if aa in PKA_SIDE:
            pka = PKA_SIDE[aa]
            if aa in ('D', 'E', 'C', 'Y'):
                # Acidic: negative when deprotonated
                charge -= 1.0 / (1.0 + 10 ** (pka - ph))
            else:
                # Basic: positive when protonated
                charge += 1.0 / (1.0 + 10 ** (ph - pka))
    return charge

def compute_charge(sequence, ph=7.4):
    """Net charge at physiological pH."""
    return _charge_at_ph(sequence, ph)

def compute_pI(sequence):
    """Isoelectric point via bisection search."""
    lo, hi = 0.0, 14.0
    for _ in range(100):
        mid = (lo + hi) / 2.0
        ch = _charge_at_ph(sequence, mid)
        if ch > 0:
            lo = mid
        else:
            hi = mid
    return (lo + hi) / 2.0

# =============================================================================
# COLOR MODES
# =============================================================================

COLOR_MODES = ['PROPERTY', 'HYDROPATHY', 'CHARGE']

def _lerp_color(c1, c2, t):
    """Linearly interpolate between two RGB colors."""
    t = max(0.0, min(1.0, t))
    return (
        int(c1[0] + (c2[0] - c1[0]) * t),
        int(c1[1] + (c2[1] - c1[1]) * t),
        int(c1[2] + (c2[2] - c1[2]) * t),
    )

def get_bead_colors(sequence, mode):
    """Return list of RGB colors for each residue in the sequence."""
    colors = []
    if mode == 'PROPERTY':
        for aa in sequence:
            cls = AA_CLASS.get(aa, 'special')
            colors.append(CLASS_COLORS.get(cls, (160, 160, 160)))
    elif mode == 'HYDROPATHY':
        # Blue (hydrophilic, -4.5) → Red (hydrophobic, +4.5)
        for aa in sequence:
            h = HYDROPATHY.get(aa, 0.0)
            t = (h + 4.5) / 9.0  # 0 = hydrophilic, 1 = hydrophobic
            colors.append(_lerp_color((40, 100, 255), (255, 60, 40), t))
    elif mode == 'CHARGE':
        # Blue (+) → Gray (0) → Red (-)
        for aa in sequence:
            pka = PKA_SIDE.get(aa)
            if pka is None:
                colors.append((140, 140, 140))  # Neutral gray
            elif aa in ('K', 'R', 'H'):
                colors.append((60, 120, 255))  # Positive blue
            elif aa in ('D', 'E'):
                colors.append((255, 60, 60))   # Negative red
            elif aa in ('C', 'Y'):
                colors.append((180, 180, 120))  # Weakly ionizable
            else:
                colors.append((140, 140, 140))
    else:
        colors = [(180, 180, 180)] * len(sequence)
    return colors

# =============================================================================
# PEPTIDE DATA
# =============================================================================

## Cα coordinates sourced from RCSB Protein Data Bank (rcsb.org).
## Generated by tools/fetch_peptides.py — 35/42 from real PDB structures,
## 7 fallback-generated where no free peptide structure exists.

PEPTIDES = [
    # ---- HORMONES ----
    {  # PDB 1XY2:A
        'name': 'OXYTOCIN',
        'description': 'Love hormone - bonding & trust',
        'sequence': 'CYIQNCPLG',
        'cyclic': True,
        'disulfide': [(0, 5)],
        'coords': [
            (   4.61,   -1.15,   -1.96),
            (   5.12,   -2.09,    1.71),
            (   3.22,    0.44,    3.85),
            (   2.30,    2.38,    0.72),
            (  -0.45,    0.39,   -0.96),
            (  -3.57,    2.59,   -1.12),
            (  -5.59,   -0.22,   -2.70),
            (  -5.63,   -2.34,    0.46),
        ],
    },
    {  # Fallback (no free PDB structure)
        'name': 'VASOPRESSIN',
        'description': 'Antidiuretic hormone',
        'sequence': 'CYFQNCPRG',
        'cyclic': True,
        'disulfide': [(0, 5)],
        'coords': [
            (   5.44,   -0.00,   -0.00),
            (   4.17,    3.50,    1.48),
            (   0.95,    5.36,    0.51),
            (  -2.72,    4.71,   -1.30),
            (  -5.11,    1.86,   -0.96),
            (  -5.11,   -1.86,    0.96),
            (  -2.72,   -4.71,    1.30),
            (   0.95,   -5.36,   -0.51),
            (   4.17,   -3.50,   -1.48),
        ],
    },
    {  # PDB 1GCN:A
        'name': 'GLUCAGON',
        'description': 'Blood sugar mobilizer',
        'sequence': 'HSQGTFTSDYSKYLDSRRAQDFVQWLMNT',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  24.85,    3.80,    0.32),
            (  23.80,    7.37,    0.15),
            (  20.94,    6.42,   -2.16),
            (  20.08,    3.51,    0.21),
            (  16.66,    1.87,   -0.02),
            (  14.04,    4.18,    1.64),
            (  11.91,    3.89,   -1.48),
            (  10.94,    0.29,   -0.98),
            (   9.66,    1.03,    2.51),
            (   6.62,    2.97,    1.28),
            (   5.80,    1.64,   -2.22),
            (   4.45,   -1.31,   -0.28),
            (   2.05,    0.51,    2.15),
            (   0.12,    1.49,   -0.94),
            (  -0.27,   -2.22,   -1.58),
            (  -2.16,   -2.23,    1.68),
            (  -4.47,    0.73,    1.12),
            (  -5.81,   -0.52,   -2.23),
            (  -6.22,   -3.78,   -0.41),
            (  -8.33,   -2.14,    2.22),
            (  -9.94,   -0.28,   -0.63),
            ( -11.13,   -3.52,   -2.18),
            ( -12.77,   -4.37,    1.12),
            ( -15.26,   -1.66,    0.35),
            ( -16.44,   -3.10,   -2.97),
            ( -16.97,   -6.61,   -1.73),
            ( -18.90,   -4.81,    0.98),
            ( -19.94,   -1.14,    1.26),
            ( -23.33,   -2.01,    2.82),
        ],
    },
    {  # PDB 2MI1:A
        'name': 'SOMATOSTATIN',
        'description': 'Growth hormone inhibitor',
        'sequence': 'AGCKNFFWKTFTSC',
        'cyclic': True,
        'disulfide': [(2, 13)],
        'coords': [
            (  -1.57,   -7.59,    7.36),
            (   1.40,   -5.34,    6.70),
            (   1.90,   -3.37,    3.51),
            (  -1.37,   -2.84,    1.68),
            (  -1.07,   -1.73,   -1.93),
            (  -3.22,    1.25,   -2.84),
            (  -4.60,    3.86,   -0.47),
            (  -1.03,    5.05,   -0.08),
            (   0.90,    5.83,   -3.25),
            (  -0.94,    3.80,   -5.86),
            (   1.79,    1.28,   -5.15),
            (   2.67,   -1.59,   -2.84),
            (   2.04,    1.05,   -0.19),
            (   3.12,    0.35,    3.37),
        ],
    },
    {  # PDB 2GLH:A
        'name': 'CALCITONIN',
        'description': 'Calcium regulation hormone',
        'sequence': 'CGNLSTCMLGTYTQDFNKFHTFPQTAIGVGAP',
        'cyclic': False,
        'disulfide': [(0, 6)],
        'coords': [
            (  13.69,    7.67,   -0.13),
            (  14.70,    6.42,    3.42),
            (  16.48,    2.96,    3.42),
            (  16.82,    0.51,    0.43),
            (  14.92,   -2.67,    1.60),
            (  12.55,   -0.59,    3.82),
            (  11.42,    1.52,    0.77),
            (  10.49,   -1.64,   -1.28),
            (   8.95,   -3.36,    1.79),
            (   6.97,   -0.11,    2.51),
            (   5.70,    0.22,   -1.12),
            (   4.72,   -3.53,   -1.03),
            (   2.85,   -2.98,    2.33),
            (   1.14,    0.09,    0.67),
            (   0.11,   -2.20,   -2.28),
            (  -1.29,   -4.82,    0.22),
            (  -3.35,   -2.15,    2.11),
            (  -5.12,   -0.91,   -1.15),
            (  -5.55,   -4.63,   -2.14),
            (  -7.40,   -5.09,    1.28),
            (  -9.80,   -2.13,    0.52),
            ( -10.77,   -3.85,   -2.86),
            ( -14.25,   -5.05,   -1.48),
            ( -15.18,   -1.27,   -1.09),
            ( -12.63,    0.52,   -3.47),
            (  -8.91,   -0.24,   -4.22),
            (  -8.50,    3.22,   -5.92),
            ( -10.80,    5.95,   -4.41),
            (  -9.91,    5.22,   -0.69),
            (  -6.91,    2.79,   -0.43),
            (  -5.15,    4.64,    2.53),
            (  -5.98,    5.50,    6.23),
        ],
    },
    {  # PDB 1YY1:A
        'name': 'GnRH',
        'description': 'Reproductive hormone',
        'sequence': 'QHWSYGLRPG',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -5.34,    5.24,   -2.96),
            (  -3.34,    2.14,   -3.94),
            (   0.24,    2.23,   -2.66),
            (   2.67,    0.68,   -0.21),
            (   0.67,    1.99,    2.74),
            (   1.27,    0.62,    6.27),
            (   1.46,   -2.83,    4.57),
            (   2.25,   -4.35,    1.14),
            (   1.82,   -2.31,   -2.05),
            (  -1.71,   -3.42,   -2.89),
        ],
    },
    {  # Fallback (no free PDB structure)
        'name': 'GASTRIN',
        'description': 'Stomach acid secretion signal',
        'sequence': 'QGPWLEEEEEAYGWMDF',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -25.60,   -0.02,    1.51),
            ( -22.40,    1.42,    0.69),
            ( -19.20,    1.98,   -0.87),
            ( -16.00,    1.33,   -1.47),
            ( -12.80,   -0.13,   -0.45),
            (  -9.60,   -1.53,    1.07),
            (  -6.40,   -2.01,    1.44),
            (  -3.20,   -1.28,    0.24),
            (   0.00,    0.22,   -1.21),
            (   3.20,    1.57,   -1.32),
            (   6.40,    1.96,    0.02),
            (   9.60,    1.15,    1.35),
            (  12.80,   -0.37,    1.22),
            (  16.00,   -1.67,   -0.23),
            (  19.20,   -1.98,   -1.42),
            (  22.40,   -1.09,   -1.04),
            (  25.60,    0.45,    0.48),
        ],
    },
    {  # PDB 1LBJ:A
        'name': 'MOTILIN',
        'description': 'GI motility hormone',
        'sequence': 'FVPIFTYGELQRMQEKERNKGQ',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -11.26,    3.80,   -2.84),
            ( -12.64,    1.43,   -0.18),
            ( -10.81,    2.24,    3.12),
            ( -10.48,   -1.55,    3.69),
            (  -8.01,   -1.17,    6.54),
            (  -7.58,    2.51,    5.62),
            (  -6.57,    2.74,    1.93),
            (  -3.45,    4.76,    2.87),
            (  -2.09,    1.65,    4.66),
            (  -2.73,   -0.57,    1.61),
            (  -1.07,    2.05,   -0.61),
            (   1.88,    2.22,    1.83),
            (   2.18,   -1.60,    1.78),
            (   2.00,   -1.62,   -2.05),
            (   4.57,    1.20,   -2.21),
            (   6.92,   -0.69,    0.14),
            (   6.50,   -3.92,   -1.87),
            (   7.41,   -1.88,   -4.98),
            (  10.34,   -0.28,   -3.06),
            (  11.65,   -3.79,   -2.30),
            (  10.89,   -5.19,   -5.78),
            (  12.33,   -2.35,   -7.90),
        ],
    },
    # ---- NEUROPEPTIDES ----
    {  # PDB 1PLW:A
        'name': 'MET-ENKEPHALIN',
        'description': 'Natural painkiller opioid',
        'sequence': 'YGGFM',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -0.12,    2.06,    3.95),
            (  -0.61,    3.58,    0.51),
            (  -1.30,    0.71,   -1.86),
            (   1.73,   -1.56,   -1.99),
            (   0.29,   -4.79,   -0.60),
        ],
    },
    {  # PDB 2KSA:B
        'name': 'SUBSTANCE P',
        'description': 'Pain neuropeptide',
        'sequence': 'RPKPQQFFGLM',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (   0.48,  -10.66,    0.58),
            (   0.46,   -6.87,    1.39),
            (  -2.38,   -4.80,   -0.06),
            (  -1.06,   -2.67,   -3.05),
            (  -3.44,    0.24,   -2.31),
            (  -1.21,    1.43,    0.54),
            (   1.64,    1.43,   -1.95),
            (   0.65,    4.87,   -3.21),
            (   0.22,    6.22,    0.29),
            (   2.43,    4.11,    2.50),
            (   2.21,    6.69,    5.28),
        ],
    },
    {  # PDB 1RON:A
        'name': 'NEUROPEPTIDE Y',
        'description': 'Appetite & stress regulator',
        'sequence': 'YPSKPDNPGEDAPAEDMARYYSALRHYINLITRQRY',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -3.15,    1.99,  -25.13),
            (  -0.73,    3.42,  -22.48),
            (   0.51,   -0.17,  -22.13),
            (   0.59,   -3.27,  -24.39),
            (  -0.95,   -5.73,  -21.80),
            (  -3.61,   -4.60,  -19.27),
            (  -3.48,   -4.88,  -15.44),
            (  -4.83,   -2.56,  -12.62),
            (  -1.38,   -0.91,  -12.10),
            (  -1.05,   -2.65,   -8.64),
            (   1.65,   -4.98,  -10.06),
            (   4.40,   -3.23,   -8.09),
            (   3.35,   -4.18,   -4.50),
            (   6.67,   -5.73,   -3.79),
            (   7.36,   -2.04,   -3.11),
            (   4.15,   -0.87,   -1.58),
            (   3.90,   -3.94,    0.64),
            (   7.45,   -3.11,    1.60),
            (   6.02,    0.27,    2.15),
            (   3.36,   -1.66,    4.22),
            (   5.47,   -2.86,    6.94),
            (   5.73,    0.89,    7.16),
            (   2.12,    1.72,    5.86),
            (   0.27,   -0.76,    8.08),
            (   2.70,   -0.33,   10.79),
            (   2.18,    3.38,   10.50),
            (  -1.43,    2.73,   10.34),
            (  -1.47,    1.01,   13.51),
            (   0.25,    4.00,   14.98),
            (  -2.19,    6.61,   13.91),
            (  -5.12,    4.28,   13.99),
            (  -4.61,    3.36,   17.60),
            (  -5.55,    7.03,   18.08),
            (  -8.56,    6.74,   15.78),
            (  -9.97,    4.16,   18.18),
            ( -10.04,    6.85,   20.84),
        ],
    },
    {  # PDB 6TUB:A
        'name': 'BETA-ENDORPHIN',
        'description': 'Runners high endorphin',
        'sequence': 'YGGFMTSEKSQTPLVTLFKNAIIKNAYKKGE',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (   5.63,    1.50,    4.80),
            (   3.34,    4.36,    3.83),
            (  -0.28,    4.95,    2.90),
            (  -2.14,    1.66,    2.63),
            (  -0.28,   -1.25,    4.24),
            (  -0.67,   -4.37,    2.10),
            (   0.87,   -7.29,    4.00),
            (   0.15,  -10.54,    2.16),
            (   2.07,  -13.65,    3.22),
            (   1.62,  -16.61,    0.87),
            (   3.84,  -19.13,   -0.92),
            (   1.96,  -18.55,   -4.18),
            (   1.72,  -16.05,   -7.06),
            (  -0.79,  -13.64,   -5.52),
            (  -1.77,  -10.16,   -6.69),
            (  -2.49,   -6.81,   -5.02),
            (  -5.84,   -5.52,   -6.25),
            (  -5.53,   -1.75,   -5.83),
            (  -8.24,    0.35,   -7.48),
            (  -8.98,    4.07,   -7.21),
            (  -5.73,    4.42,   -5.28),
            (  -5.29,    8.07,   -4.30),
            (  -2.28,    9.21,   -2.27),
            (  -3.03,   12.53,   -0.58),
            (   0.02,   13.68,    1.38),
            (   0.81,   10.10,    2.39),
            (   4.00,   11.47,    3.95),
            (   4.07,   14.66,    6.01),
            (   7.00,   17.02,    6.58),
            (   8.51,   15.29,    9.60),
            (   7.72,   11.98,    7.92),
        ],
    },
    {  # PDB 2N2F:A
        'name': 'DYNORPHIN A',
        'description': 'Kappa opioid neuropeptide',
        'sequence': 'YGGFLRRIRPKLK',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -2.31,   -3.61,    9.04),
            (  -2.04,   -2.79,    5.29),
            (  -0.10,    0.53,    5.24),
            (   3.24,   -0.52,    3.59),
            (   1.91,   -3.01,    1.00),
            (   2.07,    0.40,   -0.85),
            (   5.53,   -0.94,   -1.92),
            (   3.52,   -1.71,   -5.08),
            (   0.55,    0.64,   -5.96),
            (   0.87,    3.33,   -3.16),
            (  -2.74,    4.69,   -3.63),
            (  -4.69,    1.34,   -3.64),
            (  -5.81,    1.64,    0.08),
        ],
    },
    {  # PDB 2LNE:A
        'name': 'NEUROTENSIN',
        'description': 'Dopamine modulator',
        'sequence': 'QLYENKPRRPYIL',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -5.51,  -10.62,    4.29),
            (  -5.89,   -7.57,    6.52),
            (  -5.09,   -4.16,    5.03),
            (  -1.77,   -2.89,    6.39),
            (  -0.58,    0.72,    6.51),
            (   0.77,    1.67,    3.09),
            (   3.98,    3.75,    2.74),
            (   4.27,    5.89,   -0.38),
            (   2.80,    4.65,   -3.66),
            (   2.96,    0.79,   -3.49),
            (   3.10,    0.27,   -7.26),
            (   0.24,    2.41,   -8.55),
            (   0.71,    5.10,  -11.21),
        ],
    },
    {  # PDB 1R02:A
        'name': 'OREXIN-A',
        'description': 'Sleep/wake regulator',
        'sequence': 'QPLPDCCRQKTCSCRLYELLHGAGNHAAGILTL',
        'cyclic': False,
        'disulfide': [(5, 11), (6, 14)],
        'coords': [
            (   5.63,   22.03,    1.71),
            (   4.02,   19.44,   -0.65),
            (   6.84,   17.12,    0.42),
            (   7.95,   14.11,   -1.70),
            (   5.08,   13.08,   -3.98),
            (   3.61,   10.40,   -1.72),
            (   0.90,    9.26,   -4.14),
            (  -0.91,   12.53,   -4.81),
            (   0.33,   13.79,   -1.44),
            (  -2.13,   11.45,    0.26),
            (   0.25,   10.98,    3.21),
            (   1.89,    8.05,    1.39),
            (  -1.18,    5.83,    1.77),
            (   0.44,    3.57,   -0.83),
            (   2.71,    2.37,    1.99),
            (  -0.12,    0.28,    3.42),
            (  -1.33,   -0.74,   -0.04),
            (   2.25,   -1.75,   -0.84),
            (   2.76,   -4.39,    1.84),
            (  -0.82,   -5.49,    1.18),
            (  -0.24,   -6.23,   -2.51),
            (   3.51,   -6.78,   -2.56),
            (   4.20,   -8.44,    0.79),
            (   0.59,   -9.42,    1.38),
            (   1.20,  -13.16,    1.07),
            (  -1.04,  -13.43,    4.13),
            (  -3.81,  -11.28,    2.65),
            (  -3.72,  -12.85,   -0.81),
            (  -3.90,  -16.37,    0.59),
            (  -7.12,  -15.36,    2.33),
            (  -8.55,  -13.50,   -0.66),
            (  -8.23,  -16.71,   -2.67),
            ( -11.05,  -18.40,   -0.76),
        ],
    },
    {  # PDB 1CQ0:A
        'name': 'OREXIN-B',
        'description': 'Appetite/wakefulness signal',
        'sequence': 'RSGPPGLQGRLQRLLQASGNHAAGILTM',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  14.14,   -0.74,    9.66),
            (  13.86,   -2.90,    6.51),
            (  16.02,   -2.91,    3.35),
            (  14.02,   -2.10,    0.22),
            (  11.43,    0.51,    1.19),
            (   9.61,   -0.01,   -2.11),
            (   8.77,   -3.74,   -2.13),
            (   6.80,   -4.39,    1.06),
            (   5.98,   -0.69,    0.77),
            (   4.61,   -0.69,   -2.77),
            (   3.24,   -4.08,   -1.78),
            (   1.56,   -3.27,    1.51),
            (   0.72,    0.03,   -0.19),
            (  -0.66,   -1.25,   -3.48),
            (  -1.97,   -4.25,   -1.54),
            (  -3.53,   -2.40,    1.38),
            (  -4.55,    0.42,   -0.95),
            (  -5.73,   -1.95,   -3.69),
            (  -6.88,   -4.48,   -1.12),
            (  -7.93,   -2.59,    2.05),
            (  -8.42,    1.17,    1.82),
            (  -8.85,    1.27,   -1.95),
            ( -12.02,    3.25,   -1.30),
            ( -10.37,    5.64,    1.12),
            (  -7.72,    5.66,   -1.64),
            ( -10.18,    6.25,   -4.47),
            ( -12.12,    8.70,   -2.26),
            (  -9.88,    9.53,    0.74),
        ],
    },
    # ---- VASOACTIVE / CARDIOVASCULAR ----
    {  # PDB 6F3V:A
        'name': 'BRADYKININ',
        'description': 'Pain & inflammation signal',
        'sequence': 'RPPGFSPFR',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -0.20,   -0.79,    6.86),
            (  -2.89,   -1.20,    4.17),
            (  -2.23,   -2.01,    0.49),
            (  -3.32,    1.45,   -0.62),
            (  -0.33,    2.87,    1.25),
            (   2.17,    0.23,    0.14),
            (   4.51,    0.98,   -2.79),
            (   2.78,   -1.73,   -4.83),
            (  -0.50,    0.19,   -4.67),
        ],
    },
    {  # PDB 1N9V:A
        'name': 'ANGIOTENSIN II',
        'description': 'Blood pressure regulator',
        'sequence': 'DRVYIHPF',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -1.46,   -5.38,    5.00),
            (  -1.18,   -1.54,    5.13),
            (   2.62,   -1.48,    5.34),
            (   3.13,   -1.06,    1.60),
            (   0.15,    0.12,   -0.40),
            (   0.71,    1.85,   -3.73),
            (  -2.76,    2.99,   -4.89),
            (  -1.20,    4.50,   -8.05),
        ],
    },
    {  # PDB 1ANP:A
        'name': 'ANP',
        'description': 'Heart blood pressure signal',
        'sequence': 'SLRRSSCFGGRMDRIGAQSGLGCNSFRY',
        'cyclic': False,
        'disulfide': [(6, 22)],
        'coords': [
            (   1.27,  -12.06,    3.55),
            (   1.17,   -9.71,    0.53),
            (   4.22,   -7.74,   -0.73),
            (   4.76,   -4.89,   -3.26),
            (   1.65,   -2.77,   -3.92),
            (   0.24,    0.74,   -4.52),
            (  -1.78,    3.45,   -2.69),
            (  -4.48,    2.38,   -0.18),
            (  -6.42,    5.55,   -0.88),
            ( -10.09,    6.30,   -1.57),
            ( -11.12,    4.54,    1.66),
            (  -9.14,    1.31,    2.20),
            (  -7.27,   -0.96,   -0.25),
            (  -3.56,   -1.95,   -0.46),
            (  -2.02,   -1.03,    2.94),
            (   0.68,   -3.29,    4.54),
            (   0.22,   -4.99,    1.12),
            (   3.24,   -2.82,    0.14),
            (   6.97,   -3.59,    0.24),
            (   8.57,   -0.65,   -1.63),
            (   5.61,    1.78,   -1.76),
            (   4.16,    2.08,   -5.29),
            (   2.66,    5.42,   -4.16),
            (   5.16,    7.37,   -1.96),
            (   3.68,    6.72,    1.52),
            (   0.25,    5.61,    2.84),
            (  -0.42,    3.10,    5.65),
            (   1.79,    0.05,    6.34),
        ],
    },
    {  # PDB 1EDN:A
        'name': 'ENDOTHELIN-1',
        'description': 'Vasoconstrictor peptide',
        'sequence': 'CSCSSLMDKECVYFCHLDIIW',
        'cyclic': False,
        'disulfide': [(0, 10), (2, 14)],
        'coords': [
            (  -0.55,    1.89,    6.65),
            (   3.21,    2.44,    6.54),
            (   4.54,    1.75,    3.04),
            (   7.28,   -0.05,    1.18),
            (   8.54,    2.95,   -0.85),
            (   6.41,    2.99,   -4.00),
            (   4.26,   -0.17,   -3.62),
            (   6.82,   -3.04,   -3.97),
            (   6.99,   -6.49,   -2.28),
            (   4.95,   -4.99,    0.55),
            (   2.48,   -2.11,    0.02),
            (  -0.96,   -3.17,   -1.23),
            (  -3.09,   -5.99,    0.15),
            (  -2.88,   -3.10,    2.67),
            (  -2.66,    0.40,    1.05),
            (  -4.74,    0.69,   -2.15),
            (  -7.69,   -0.16,    0.06),
            (  -8.78,    2.81,    2.24),
            (  -6.51,    5.61,    0.83),
            (  -7.98,    5.39,   -2.67),
            (  -9.63,    2.37,   -4.22),
        ],
    },
    # ---- ANTIMICROBIAL ----
    {  # PDB 2MAG:A
        'name': 'MAGAININ 2',
        'description': 'Frog skin antibiotic',
        'sequence': 'GIGKFLHSAKKFGKAFVGEIMNS',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -16.20,   -1.49,   -0.93),
            ( -14.20,   -4.68,   -0.82),
            ( -12.55,   -3.40,   -3.97),
            ( -11.32,    0.08,   -3.28),
            ( -10.02,   -0.96,    0.10),
            (  -8.00,   -3.63,   -1.62),
            (  -6.85,   -1.06,   -4.12),
            (  -5.58,    1.06,   -1.29),
            (  -4.02,   -1.93,    0.35),
            (  -1.88,   -2.12,   -2.74),
            (  -0.98,    1.51,   -3.09),
            (  -0.56,    2.00,    0.62),
            (   1.36,   -1.24,    0.42),
            (   3.78,    0.16,   -2.10),
            (   4.19,    3.19,    0.09),
            (   4.98,    0.77,    2.87),
            (   7.48,   -1.05,    0.73),
            (   9.12,    2.28,    0.08),
            (   9.27,    2.91,    3.79),
            (  11.07,   -0.34,    4.38),
            (  13.28,    0.21,    1.38),
            (  14.06,    3.63,    2.73),
            (  13.58,    4.10,    6.43),
        ],
    },
    {  # PDB 2MLT:A
        'name': 'MELITTIN',
        'description': 'Bee venom pore-former',
        'sequence': 'GIGAVLKVLTTGLPALISWIKRKRQQ',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  13.31,   -8.60,    7.71),
            (  13.91,   -5.29,    5.86),
            (  13.71,   -7.37,    2.71),
            (  10.09,   -8.37,    3.49),
            (   9.06,   -4.77,    4.47),
            (  10.77,   -3.54,    1.34),
            (   8.79,   -5.75,   -0.98),
            (   5.50,   -4.48,    0.59),
            (   6.61,   -0.87,    0.11),
            (   7.05,   -1.62,   -3.53),
            (   3.84,   -3.51,   -4.27),
            (   1.29,   -3.70,   -1.48),
            (   1.63,   -0.03,   -0.25),
            (   0.73,    1.61,   -3.59),
            (  -2.47,   -0.53,   -3.89),
            (  -3.33,    0.24,   -0.27),
            (  -2.95,    3.95,   -1.00),
            (  -5.47,    3.72,   -3.87),
            (  -7.80,    1.81,   -1.54),
            (  -7.66,    4.53,    1.15),
            (  -8.40,    7.13,   -1.46),
            ( -11.55,    5.17,   -2.60),
            ( -12.79,    4.82,    0.93),
            ( -12.23,    8.57,    1.66),
            ( -14.46,    9.62,   -1.28),
            ( -17.16,    7.25,   -0.03),
        ],
    },
    {  # PDB 1DFN:A
        'name': 'DEFENSIN',
        'description': 'Human innate immune defense',
        'sequence': 'ACYCRIPACIAGERRYGTCIYQGRLWAFCC',
        'cyclic': False,
        'disulfide': [(1, 28), (4, 19), (9, 29)],
        'coords': [
            (   2.54,    9.06,    6.43),
            (   1.33,    5.68,    5.20),
            (  -0.37,    5.08,    1.88),
            (  -2.39,    2.41,    0.11),
            (  -0.55,    1.69,   -3.21),
            (  -0.83,   -0.40,   -6.37),
            (   1.12,   -2.11,   -7.70),
            (   3.67,   -1.78,   -4.84),
            (   5.36,    0.44,   -2.26),
            (   7.84,    2.99,   -3.66),
            (  11.43,    3.86,   -2.73),
            (  11.82,    4.62,    0.93),
            (   8.68,    2.77,    2.08),
            (   8.16,   -0.80,    3.36),
            (   4.85,   -2.67,    3.06),
            (   3.13,   -3.16,    6.44),
            (  -0.26,   -4.54,    5.52),
            (  -3.06,   -4.45,    2.97),
            (  -5.85,   -2.01,    2.12),
            (  -9.21,   -2.86,    0.67),
            ( -10.55,   -0.03,   -1.50),
            ( -12.60,    0.13,   -4.70),
            ( -12.97,   -3.66,   -4.78),
            (  -9.16,   -4.21,   -4.96),
            (  -6.24,   -5.07,   -2.70),
            (  -3.54,   -2.39,   -2.13),
            (  -0.21,   -2.66,   -0.30),
            (  -0.25,   -0.54,    2.94),
            (   3.14,    1.20,    2.84),
            (   4.94,    3.38,    5.29),
        ],
    },
    {  # PDB 2K6O:A
        'name': 'LL-37',
        'description': 'Human cathelicidin antibiotic',
        'sequence': 'LLGDFFRKSKEKIGKEFKRIVQRIKDFLRNLVPRTES',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -25.79,    3.01,    5.04),
            ( -22.73,    5.05,    6.01),
            ( -21.91,    2.86,    8.99),
            ( -22.00,   -0.03,    6.54),
            ( -19.79,    1.95,    4.17),
            ( -17.07,    2.39,    6.72),
            ( -17.08,   -1.37,    7.27),
            ( -16.96,   -1.97,    3.52),
            ( -14.35,    0.69,    2.77),
            ( -12.37,   -0.54,    5.77),
            ( -11.45,   -3.87,    4.17),
            ( -11.19,   -2.28,    0.73),
            (  -8.04,   -0.53,    1.95),
            (  -6.44,   -3.62,    3.46),
            (  -6.63,   -5.10,   -0.04),
            (  -5.15,   -2.17,   -1.96),
            (  -3.09,   -0.90,    0.98),
            (  -1.31,   -4.25,    1.05),
            (  -0.54,   -4.17,   -2.67),
            (   0.54,   -0.56,   -2.26),
            (   2.94,   -1.19,    0.62),
            (   4.35,   -4.06,   -1.43),
            (   4.70,   -1.94,   -4.56),
            (   6.16,    1.07,   -2.76),
            (   8.73,   -1.25,   -1.19),
            (   9.99,   -1.92,   -4.71),
            (  10.02,    1.78,   -5.56),
            (  12.60,    2.57,   -2.89),
            (  14.71,   -0.18,   -4.46),
            (  14.65,    1.42,   -7.92),
            (  14.87,    4.85,   -6.29),
            (  18.42,    4.91,   -4.91),
            (  20.99,    4.94,   -7.78),
            (  23.54,    3.16,   -5.60),
            (  22.79,    1.06,   -2.53),
            (  25.17,    0.53,    0.39),
            (  28.72,   -0.33,   -0.66),
        ],
    },
    {  # Fallback (no free PDB structure)
        'name': 'GRAMICIDIN S',
        'description': 'Bacterial cyclic antibiotic',
        'sequence': 'VOLFPVOLFP',
        'cyclic': True,
        'disulfide': [],
        'coords': [
            (   6.05,   -0.00,   -0.00),
            (   4.89,    3.55,    1.43),
            (   1.87,    5.75,    0.88),
            (  -1.87,    5.75,   -0.88),
            (  -4.89,    3.55,   -1.43),
            (  -6.05,    0.00,   -0.00),
            (  -4.89,   -3.55,    1.43),
            (  -1.87,   -5.75,    0.88),
            (   1.87,   -5.75,   -0.88),
            (   4.89,   -3.55,   -1.43),
        ],
    },
    {  # Fallback (modified residues not in standard ATOM records)
        'name': 'NISIN',
        'description': 'Food preservative lantibiotic',
        'sequence': 'ITSISLCTPGCKTGALMGCNMKTATCHCSIHVSK',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -52.80,   -0.08,    1.51), ( -49.60,    1.36,    0.69),
            ( -46.40,    1.92,   -0.87), ( -43.20,    1.27,   -1.47),
            ( -40.00,   -0.19,   -0.45), ( -36.80,   -1.59,    1.07),
            ( -33.60,   -2.07,    1.43), ( -30.40,   -1.34,    0.24),
            ( -27.20,    0.16,   -1.21), ( -24.00,    1.51,   -1.32),
            ( -20.80,    1.90,    0.02), ( -17.60,    1.09,    1.35),
            ( -14.40,   -0.43,    1.22), ( -11.20,   -1.73,   -0.23),
            (  -8.00,   -2.04,   -1.42), (  -4.80,   -1.15,   -1.04),
            (  -1.60,    0.39,    0.48), (   1.60,    1.64,    1.49),
            (   4.80,    1.85,    0.88), (   8.00,    0.90,   -0.68),
            (  11.20,   -0.65,   -1.49), (  14.40,   -1.85,   -0.66),
            (  17.60,   -1.97,    0.90), (  20.80,   -0.95,    1.49),
            (  24.00,    0.61,    0.46), (  27.20,    1.75,   -1.06),
            (  30.40,    1.78,   -1.41), (  33.60,    0.69,   -0.21),
            (  36.80,   -0.87,    1.23), (  40.00,   -1.95,    1.34),
            (  43.20,   -1.89,   -0.01), (  46.40,   -0.73,   -1.34),
            (  49.60,    0.82,   -1.19), (  52.80,    1.83,    0.27),
        ],
    },
    {  # PDB 1MA2:A
        'name': 'TACHYPLESIN',
        'description': 'Horseshoe crab antimicrobial',
        'sequence': 'KWCFRVCYRGICYRRCR',
        'cyclic': False,
        'disulfide': [(2, 15), (5, 12)],
        'coords': [
            (  -6.33,   -9.69,    3.62),
            (  -2.60,   -9.35,    2.98),
            (  -1.42,   -7.66,   -0.21),
            (  -2.67,   -4.06,   -0.35),
            (  -1.00,   -1.90,   -3.00),
            (  -2.48,    1.52,   -2.21),
            (  -1.35,    5.08,   -1.51),
            (  -2.28,    7.39,    1.36),
            (  -2.20,   11.18,    1.04),
            (   1.33,   11.33,   -0.34),
            (   2.73,    7.85,    0.24),
            (   2.39,    4.85,   -2.07),
            (   2.72,    1.47,   -0.37),
            (   3.47,   -1.20,   -2.97),
            (   4.61,   -3.72,   -0.35),
            (   2.25,   -6.65,    0.19),
            (   2.83,   -6.43,    3.94),
        ],
    },
    # ---- TOXINS / VENOMS ----
    {  # PDB 1IM1:A
        'name': 'CONOTOXIN',
        'description': 'Cone snail neurotoxin',
        'sequence': 'GCCSDPRCAWRC',
        'cyclic': False,
        'disulfide': [(2, 7), (3, 11)],
        'coords': [
            (   1.70,    5.43,    4.67),
            (   0.95,    1.89,    3.48),
            (   0.56,    2.83,   -0.21),
            (   4.37,    3.03,   -0.65),
            (   4.62,   -0.68,    0.29),
            (   3.32,   -2.62,   -2.77),
            (   2.43,   -5.42,   -0.27),
            (   0.03,   -2.78,    1.25),
            (  -1.10,   -1.13,   -1.99),
            (  -4.59,   -2.72,   -1.80),
            (  -7.50,   -0.27,   -1.12),
            (  -4.79,    2.43,   -0.88),
        ],
    },
    {  # PDB 1TTK:A
        'name': 'ZICONOTIDE',
        'description': 'Cone snail painkiller drug',
        'sequence': 'CKGKGAKCSRLMYDCCTGSCRSGKC',
        'cyclic': False,
        'disulfide': [(0, 15), (7, 19), (14, 24)],
        'coords': [
            (   1.97,   -6.05,    3.62),
            (   1.61,   -2.72,    5.52),
            (  -0.79,   -0.40,    7.35),
            (  -2.88,    2.15,    5.42),
            (  -1.08,    5.38,    4.48),
            (   2.25,    3.42,    4.71),
            (   4.75,    2.51,    1.96),
            (   3.02,    0.70,   -0.95),
            (   3.30,   -0.43,   -4.58),
            (   0.56,   -0.43,   -7.25),
            (   2.15,   -3.68,   -8.53),
            (   2.32,   -5.57,   -5.18),
            (  -0.34,   -3.91,   -3.03),
            (   1.78,   -4.50,    0.04),
            (  -1.00,   -2.78,    1.96),
            (  -2.58,   -4.98,    4.66),
            (  -5.22,   -2.27,    5.05),
            (  -5.96,   -1.59,    1.35),
            (  -4.26,   -1.00,   -1.98),
            (  -1.49,    1.38,   -3.06),
            (  -2.18,    5.07,   -3.65),
            (   0.78,    6.62,   -5.51),
            (   3.34,    4.86,   -3.31),
            (   1.32,    5.37,   -0.08),
            (  -1.38,    2.84,    1.00),
        ],
    },
    {  # PDB 1CHL:A
        'name': 'CHLOROTOXIN',
        'description': 'Scorpion glioma-binding toxin',
        'sequence': 'MCMPCFTTDHQMARKCDDCCGGKGRGKCYGPQCLCR',
        'cyclic': False,
        'disulfide': [(1, 19), (4, 32), (7, 27), (16, 34)],
        'coords': [
            (  -4.19,    0.50,    7.56),
            (  -0.77,   -0.98,    6.70),
            (   2.77,    0.47,    6.88),
            (   3.05,    3.91,    5.32),
            (   4.17,    4.27,    1.69),
            (   7.73,    5.66,    1.60),
            (  10.07,    2.66,    1.40),
            (  12.01,    1.19,   -1.55),
            (  10.67,    2.16,   -4.99),
            (  10.48,   -0.88,   -7.29),
            (   8.73,   -2.88,   -4.55),
            (   6.58,   -0.61,   -2.35),
            (   2.99,   -0.95,   -3.60),
            (   3.68,   -4.67,   -4.15),
            (   2.66,   -5.39,   -0.53),
            (   0.54,   -2.35,    0.42),
            (  -2.55,   -3.15,   -1.66),
            (  -2.20,   -6.81,   -0.62),
            (  -2.00,   -5.78,    3.05),
            (  -5.62,   -4.61,    2.75),
            (  -6.68,   -7.46,    0.42),
            (  -5.35,   -7.03,   -3.12),
            (  -6.97,   -6.51,   -6.54),
            (  -6.95,   -2.73,   -6.00),
            (  -8.12,   -2.99,   -2.37),
            (  -5.14,   -1.05,   -0.99),
            (  -2.85,    1.71,   -2.32),
            (  -0.49,    4.49,   -1.18),
            (  -2.72,    7.39,   -0.01),
            (  -0.38,   10.31,    0.75),
            (   1.50,    9.45,    3.92),
            (  -0.81,    6.55,    4.86),
            (  -1.42,    3.15,    3.22),
            (  -5.13,    2.22,    3.30),
            (  -7.59,   -0.09,    1.50),
            (  -9.71,    0.86,   -1.53),
        ],
    },
    {  # PDB 7OXF:A
        'name': 'APAMIN',
        'description': 'Bee venom neurotoxin',
        'sequence': 'CNCKAPETALCARRCQQH',
        'cyclic': False,
        'disulfide': [(0, 10), (2, 14)],
        'coords': [
            (  -4.66,   -0.65,    5.50),
            (  -4.92,   -3.03,    2.55),
            (  -2.19,   -4.15,    0.15),
            (  -4.93,   -4.93,   -2.37),
            (  -6.59,   -1.53,   -2.00),
            (  -4.37,    0.89,   -0.03),
            (  -6.27,    4.15,    0.43),
            (  -2.99,    5.91,    1.22),
            (  -0.28,    6.01,   -1.44),
            (   2.23,    5.44,    1.36),
            (   0.54,    2.16,    2.26),
            (   0.65,    0.90,   -1.33),
            (   4.41,    1.47,   -1.44),
            (   4.96,   -0.22,    1.93),
            (   2.76,   -3.17,    0.94),
            (   4.36,   -3.34,   -2.51),
            (   7.83,   -3.49,   -0.98),
            (   9.47,   -2.42,   -4.24),
        ],
    },
    {  # PDB 1ROO:A
        'name': 'SHK TOXIN',
        'description': 'Sea anemone K+ channel blocker',
        'sequence': 'RSCIDTIPKSRCTAFQCKHSMKYRLSFCRKTCGTC',
        'cyclic': False,
        'disulfide': [(2, 32), (5, 27), (16, 24)],
        'coords': [
            (  -9.62,    3.29,  -10.88),
            (  -6.74,    0.77,  -10.93),
            (  -4.87,   -0.71,   -7.95),
            (  -1.08,   -0.21,   -8.25),
            (   1.96,    0.35,   -6.16),
            (   5.39,    1.94,   -6.58),
            (   6.52,   -0.60,   -3.93),
            (   4.30,   -3.45,   -2.57),
            (   4.90,   -5.73,    0.33),
            (   8.51,   -4.56,    0.15),
            (   7.84,   -1.52,    2.29),
            (   4.35,   -2.63,    3.16),
            (   3.45,   -5.04,    5.90),
            (   0.14,   -4.82,    7.84),
            (   2.14,   -2.58,   10.13),
            (   3.17,   -0.11,    7.38),
            (  -0.02,   -0.76,    5.41),
            (  -2.27,   -0.05,    8.41),
            (  -0.08,    2.64,    9.97),
            (   1.45,    4.53,    7.04),
            (  -1.68,    5.93,    5.42),
            (   0.41,    7.04,    2.42),
            (   1.71,    3.50,    2.13),
            (  -1.84,    2.15,    1.83),
            (  -3.37,    5.22,    0.06),
            (  -0.51,    5.66,   -2.44),
            (   2.56,    3.38,   -2.22),
            (   0.66,    0.09,   -2.17),
            (  -2.64,    1.04,   -3.85),
            (  -2.18,   -2.44,   -5.41),
            (  -3.51,   -4.29,   -2.35),
            (  -2.00,   -3.28,    0.96),
            (  -3.30,   -0.04,   -0.02),
            (  -6.44,   -0.57,   -1.97),
            (  -7.32,   -4.14,   -3.16),
        ],
    },
    {  # PDB 1JRJ:A
        'name': 'EXENDIN-4',
        'description': 'Gila monster GLP-1 drug',
        'sequence': 'HGEGTFTSDLSKQMEEEAVRLFIEWLKNGGPSSGAPPPS',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -27.17,   11.80,    5.83),
            ( -27.63,    8.49,    7.64),
            ( -25.40,    5.41,    7.48),
            ( -21.83,    5.23,    6.17),
            ( -19.54,    2.50,    7.51),
            ( -16.95,    2.76,    4.72),
            ( -14.15,    4.70,    6.47),
            ( -13.53,    1.68,    8.74),
            ( -12.67,   -0.55,    5.77),
            ( -11.05,    2.30,    3.80),
            (  -8.50,    2.88,    6.58),
            (  -7.38,   -0.76,    6.40),
            (  -7.41,   -0.83,    2.58),
            (  -5.00,    2.13,    2.57),
            (  -2.45,    0.11,    4.56),
            (  -2.93,   -2.90,    2.26),
            (  -2.20,   -0.77,   -0.82),
            (   1.19,    0.23,    0.62),
            (   2.08,   -3.47,    0.98),
            (   1.34,   -4.08,   -2.72),
            (   3.70,   -1.25,   -3.72),
            (   6.42,   -2.55,   -1.39),
            (   5.93,   -6.07,   -2.78),
            (   6.28,   -4.81,   -6.37),
            (   9.41,   -2.87,   -5.38),
            (  11.01,   -6.03,   -3.96),
            (  10.11,   -7.93,   -7.15),
            (  12.01,   -5.45,   -9.35),
            (  15.10,   -5.89,   -7.14),
            (  14.31,   -4.00,   -3.94),
            (  17.27,   -2.00,   -2.51),
            (  19.56,   -3.26,   -5.29),
            (  17.25,   -2.10,   -8.10),
            (  17.99,    1.63,   -8.38),
            (  14.78,    3.24,   -7.11),
            (  13.94,    3.90,   -3.41),
            (  11.42,    1.81,   -1.37),
            (   7.70,    2.74,   -1.65),
            (   6.98,    4.06,    1.86),
        ],
    },
    # ---- SIGNALING / IMMUNE / OTHER ----
    {  # Fallback (no free PDB structure)
        'name': 'ACTH',
        'description': 'Stress response hormone',
        'sequence': 'SYSMEHFRWGKPVGKKRRPVKVYPNGAEDESAEAFPLEF',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -60.80,   -0.01,    1.52), ( -57.60,    1.43,    0.70),
            ( -54.40,    1.99,   -0.87), ( -51.20,    1.34,   -1.46),
            ( -48.00,   -0.12,   -0.44), ( -44.80,   -1.52,    1.08),
            ( -41.60,   -2.00,    1.44), ( -38.40,   -1.27,    0.25),
            ( -35.20,    0.23,   -1.20), ( -32.00,    1.58,   -1.32),
            ( -28.80,    1.97,    0.02), ( -25.60,    1.16,    1.36),
            ( -22.40,   -0.36,    1.23), ( -19.20,   -1.66,   -0.23),
            ( -16.00,   -1.97,   -1.41), ( -12.80,   -1.08,   -1.04),
            (  -9.60,    0.46,    0.49), (  -6.40,    1.71,    1.50),
            (  -3.20,    1.92,    0.89), (   0.00,    0.97,   -0.67),
            (   3.20,   -0.58,   -1.48), (   6.40,   -1.78,   -0.65),
            (   9.60,   -1.90,    0.91), (  12.80,   -0.88,    1.50),
            (  16.00,    0.68,    0.47), (  19.20,    1.82,   -1.05),
            (  22.40,    1.85,   -1.40), (  25.60,    0.76,   -0.20),
            (  28.80,   -0.80,    1.24), (  32.00,   -1.88,    1.35),
            (  35.20,   -1.82,   -0.00), (  38.40,   -0.66,   -1.33),
            (  41.60,    0.89,   -1.18), (  44.80,    1.90,    0.27),
            (  48.00,    1.75,    1.45), (  51.20,    0.53,    1.06),
            (  54.40,   -1.01,   -0.47), (  57.60,   -1.95,   -1.47),
            (  60.80,   -1.71,   -0.84),
        ],
    },
    {  # Fallback (no free PDB structure)
        'name': 'SECRETIN',
        'description': 'Digestive hormone',
        'sequence': 'HSDGTFTSELSRLREGARLQRLLQGLV',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -41.60,   -0.15,    1.51), ( -38.40,    1.28,    0.69),
            ( -35.20,    1.84,   -0.87), ( -32.00,    1.20,   -1.47),
            ( -28.80,   -0.27,   -0.45), ( -25.60,   -1.67,    1.08),
            ( -22.40,   -2.15,    1.44), ( -19.20,   -1.42,    0.24),
            ( -16.00,    0.08,   -1.20), ( -12.80,    1.43,   -1.32),
            (  -9.60,    1.82,    0.02), (  -6.40,    1.02,    1.35),
            (  -3.20,   -0.50,    1.22), (   0.00,   -1.81,   -0.23),
            (   3.20,   -2.11,   -1.42), (   6.40,   -1.23,   -1.04),
            (   9.60,    0.31,    0.49), (  12.80,    1.56,    1.50),
            (  16.00,    1.78,    0.89), (  19.20,    0.82,   -0.68),
            (  22.40,   -0.73,   -1.49), (  25.60,   -1.93,   -0.66),
            (  28.80,   -2.05,    0.91), (  32.00,   -1.02,    1.49),
            (  35.20,    0.53,    0.46), (  38.40,    1.67,   -1.06),
            (  41.60,    1.70,   -1.41),
        ],
    },
    {  # Fallback (tripeptide, too small for PDB)
        'name': 'GLUTATHIONE',
        'description': 'Master antioxidant tripeptide',
        'sequence': 'ECG',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            (  -3.20,   -1.14,    1.07),
            (  -0.00,    0.29,    0.25),
            (   3.20,    0.85,   -1.32),
        ],
    },
    {  # PDB 1M4F:A
        'name': 'HEPCIDIN',
        'description': 'Iron metabolism master regulator',
        'sequence': 'DTHFPICIFCCGCCHRSKCGMCCKT',
        'cyclic': False,
        'disulfide': [(6, 12), (7, 22), (10, 17), (13, 21)],
        'coords': [
            (  -8.05,   -7.06,   -1.60),
            ( -10.82,   -4.66,   -0.59),
            ( -12.55,   -2.92,   -3.50),
            ( -12.45,    0.42,   -1.68),
            ( -10.48,    0.11,    1.61),
            (  -8.47,    2.89,    3.26),
            (  -5.61,    2.80,    0.75),
            (  -3.35,    4.64,    3.19),
            (  -0.22,    5.83,    1.36),
            (   2.86,    3.76,    2.19),
            (   6.23,    3.87,    0.42),
            (   7.78,    0.43,    0.04),
            (  10.86,    1.01,    2.20),
            (  12.26,   -2.43,    2.45),
            (  10.11,   -5.15,    0.89),
            (   9.28,   -3.46,   -2.39),
            (  11.63,   -0.52,   -3.01),
            (   8.66,    1.39,   -4.43),
            (   5.99,    3.77,   -3.12),
            (   2.43,    2.46,   -3.17),
            (  -0.98,    2.78,   -1.52),
            (  -1.59,    0.21,    1.23),
            (  -5.14,   -0.52,    0.05),
            (  -4.99,   -4.18,    1.08),
            (  -3.39,   -5.48,    4.29),
        ],
    },
    {  # PDB 2RRH:A
        'name': 'VIP',
        'description': 'Vasoactive intestinal peptide',
        'sequence': 'HSDAVFTDNYTRLRKQMAVKKYLNSILN',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -24.21,    3.99,   -0.80),
            ( -20.62,    5.26,   -0.92),
            ( -17.92,    2.61,   -1.30),
            ( -15.43,    4.90,    0.45),
            ( -14.59,    2.30,    3.10),
            ( -13.78,   -0.23,    0.38),
            ( -11.26,    2.01,   -1.38),
            ( -10.03,    3.45,    1.91),
            (  -9.07,   -0.02,    3.13),
            (  -7.39,   -0.94,   -0.15),
            (  -5.49,    2.36,   -0.23),
            (  -4.07,    1.71,    3.24),
            (  -3.31,   -1.96,    2.55),
            (  -1.48,   -1.00,   -0.64),
            (   0.89,    1.15,    1.41),
            (   1.99,   -1.90,    3.42),
            (   2.70,   -3.92,    0.27),
            (   4.32,   -0.93,   -1.43),
            (   6.43,   -0.21,    1.66),
            (   8.20,   -3.57,    1.36),
            (   8.85,   -3.10,   -2.36),
            (  10.26,    0.39,   -1.83),
            (  12.42,   -0.57,    1.15),
            (  13.40,   -3.78,   -0.63),
            (  14.55,   -1.97,   -3.77),
            (  16.26,    0.89,   -1.95),
            (  18.32,   -1.51,    0.16),
            (  18.76,   -3.95,   -2.73),
            (  21.29,   -1.46,   -4.08),
        ],
    },
    {  # PDB 1NB1:A
        'name': 'KALATA B1',
        'description': 'Cyclotide - knotted ring',
        'sequence': 'GLPVCGETCVGGTCNTPGCTCSWPVCTRN',
        'cyclic': True,
        'disulfide': [(4, 18), (9, 21), (14, 27)],
        'coords': [
            (   4.35,    1.25,   -4.12),
            (   2.50,    0.27,   -7.27),
            (   0.73,   -2.23,   -5.08),
            (  -2.85,   -2.76,   -4.02),
            (  -4.06,   -3.83,   -0.60),
            (  -7.49,   -4.95,   -1.68),
            (  -7.02,   -7.82,    0.74),
            (  -5.75,   -5.50,    3.46),
            (  -2.16,   -6.53,    2.89),
            (   1.00,   -5.01,    1.42),
            (   4.20,   -6.77,    0.40),
            (   6.24,   -3.62,   -0.14),
            (   8.14,   -2.95,    3.12),
            (   7.07,    0.42,    4.42),
            (   3.84,    0.56,    2.48),
            (   0.74,    1.13,    4.58),
            (  -2.62,   -0.20,    3.45),
            (  -5.02,    2.41,    2.14),
            (  -7.68,    0.35,    0.38),
            (  -7.52,   -0.48,   -2.34),
            (  -3.92,    0.68,   -2.73),
            (  -0.71,    0.52,   -0.70),
            (   0.60,    3.95,    0.28),
            (   4.18,    4.83,    1.09),
            (   5.14,    7.56,    3.59),
            (   1.84,    9.35,    2.93),
            (   1.42,    8.72,   -0.82),
            (   0.75,    5.69,   -3.07),
            (   4.04,    4.96,   -4.81),
        ],
    },
    # ---- BOUNDARY: also in PROTEINS visual ----
    {  # PDB 4INS:B
        'name': 'INSULIN',
        'description': 'Blood sugar hormone B-chain',
        'sequence': 'FVNQHLCGSHLVEALYLVCGERGFFYTPKT',
        'cyclic': False,
        'disulfide': [(6, 19)],
        'coords': [
            ( -12.07,   -8.43,    0.76),
            ( -10.45,   -9.20,    4.11),
            (  -8.57,   -7.11,    6.65),
            (  -4.84,   -7.26,    6.27),
            (  -1.78,   -6.80,    8.48),
            (   0.83,   -5.09,    6.31),
            (   4.24,   -3.96,    7.27),
            (   7.23,   -2.54,    5.33),
            (   7.44,   -3.26,    1.68),
            (   4.36,   -5.42,    1.89),
            (   2.23,   -2.28,    2.32),
            (   3.72,   -0.74,   -0.80),
            (   2.87,   -3.85,   -2.76),
            (  -0.76,   -3.64,   -1.58),
            (  -0.92,    0.05,   -2.58),
            (   0.46,   -0.84,   -5.98),
            (  -2.26,   -3.51,   -6.46),
            (  -5.05,   -1.25,   -5.23),
            (  -4.13,    1.96,   -7.05),
            (  -2.38,    0.56,  -10.15),
            (  -2.10,    3.24,  -12.80),
            (  -3.79,    5.93,  -10.75),
            (  -0.54,    5.87,   -8.79),
            (  -0.28,    6.63,   -5.06),
            (   1.49,    8.50,   -2.25),
            (   3.31,    6.53,    0.42),
            (   3.40,    8.76,    3.47),
            (   4.81,    7.26,    6.66),
            (   5.07,    9.14,   10.01),
            (   8.45,   10.74,   10.60),
        ],
    },
    {  # PDB 1IYT:A
        'name': 'AMYLOID BETA',
        'description': 'Alzheimers plaque peptide',
        'sequence': 'DAEFRHDSGYEVHHQKLVFFAEDVGSNKGAIIGLMVGGVVIA',
        'cyclic': False,
        'disulfide': [],
        'coords': [
            ( -18.43,    4.79,   22.60),
            ( -15.59,    7.26,   21.89),
            ( -12.31,    5.77,   20.57),
            ( -12.40,    2.17,   21.85),
            ( -14.34,    1.07,   18.76),
            ( -12.56,    3.02,   15.99),
            (  -9.17,    1.29,   16.43),
            (  -8.99,   -1.28,   13.60),
            ( -10.34,    1.24,   11.05),
            (  -7.62,    3.69,   12.22),
            (  -4.76,    1.16,   12.35),
            (  -5.74,   -0.47,    9.00),
            (  -4.26,    1.89,    6.42),
            (  -1.56,    2.99,    8.88),
            (  -0.31,   -0.60,    8.35),
            (  -1.90,   -1.59,    4.96),
            (   0.14,    1.32,    3.54),
            (   3.40,   -0.18,    4.79),
            (   2.29,   -3.79,    4.10),
            (   1.09,   -3.11,    0.54),
            (   4.15,   -0.99,   -0.24),
            (   6.26,   -3.89,    1.10),
            (   4.36,   -6.38,   -1.03),
            (   4.92,   -4.23,   -4.13),
            (   8.41,   -3.08,   -3.11),
            (   9.77,   -6.60,   -2.63),
            (   8.11,   -7.59,   -5.94),
            (   9.20,   -4.82,   -8.34),
            (  10.30,   -7.63,  -10.66),
            (   6.54,   -8.30,  -11.04),
            (   4.98,   -4.84,  -10.54),
            (   7.43,   -3.74,  -13.29),
            (   4.35,   -3.75,  -15.59),
            (   2.96,   -0.67,  -13.78),
            (   6.43,    0.79,  -13.39),
            (   6.85,    0.73,  -17.19),
            (   3.17,    1.70,  -17.62),
            (   3.95,    4.82,  -15.54),
            (   7.26,    5.54,  -17.36),
            (   5.59,    5.81,  -20.79),
            (   3.55,    8.85,  -19.57),
            (   4.85,   11.58,  -17.20),
        ],
    },
    {  # PDB 1CRN:A
        'name': 'CRAMBIN',
        'description': 'Tiny plant seed protein',
        'sequence': 'TTCCPSIVARSNFNVCRLPGTPEALCATYTGCIIIPGATCPGDYAN',
        'cyclic': False,
        'disulfide': [(2, 15), (3, 31), (16, 25)],
        'coords': [
            (   7.41,    2.83,   -2.77),
            (   4.30,    1.52,   -1.04),
            (   4.10,    0.76,    2.68),
            (   1.09,   -0.96,    4.30),
            (  -0.11,   -0.92,    7.90),
            (  -0.89,   -4.64,    8.17),
            (  -0.65,   -7.87,    6.15),
            (  -4.42,   -7.74,    5.35),
            (  -3.96,   -4.18,    3.97),
            (  -1.06,   -5.34,    1.73),
            (  -3.06,   -8.37,    0.46),
            (  -6.02,   -6.02,   -0.36),
            (  -3.63,   -3.59,   -2.05),
            (  -2.23,   -6.34,   -4.32),
            (  -5.78,   -7.35,   -5.37),
            (  -6.67,   -3.67,   -5.98),
            (  -3.67,   -3.46,   -8.32),
            (  -4.63,   -6.52,  -10.43),
            (  -6.77,   -4.57,  -12.90),
            (  -4.19,   -1.76,  -13.13),
            (  -5.79,    0.66,  -10.62),
            (  -3.42,    3.56,   -9.80),
            (  -1.45,    3.15,   -6.61),
            (  -2.95,    6.37,   -5.19),
            (  -6.49,    4.94,   -5.35),
            (  -5.38,    1.60,   -3.92),
            (  -3.68,    3.55,   -1.08),
            (  -6.87,    5.27,    0.09),
            (  -8.85,    2.09,   -0.45),
            (  -6.57,    0.04,    1.84),
            (  -4.79,    2.39,    4.25),
            (  -1.42,    1.74,    2.53),
            (   0.72,    4.81,    1.72),
            (   2.99,    5.93,   -1.07),
            (   6.37,    7.50,   -0.17),
            (   9.07,    8.91,   -2.37),
            (  11.89,    7.02,   -0.59),
            (  12.46,    3.29,   -0.09),
            (  12.38,    2.96,    3.70),
            (   8.94,    2.36,    5.19),
            (   8.36,    3.47,    8.77),
            (   7.77,    1.01,   11.58),
            (   4.00,    1.62,   11.73),
            (   3.70,    0.79,    7.97),
            (   5.88,   -2.28,    8.14),
            (   3.95,   -4.56,    5.77),
        ],
    },
]

# =============================================================================
# VISUAL CLASS
# =============================================================================

class Peptides(Visual):
    name = "PEPTIDES"
    description = "Peptide bead models + calculator"
    category = "science"

    def __init__(self, display: Display):
        super().__init__(display)

    def reset(self):
        self.time = 0.0
        self.peptide_idx = 0
        self.color_mode_idx = 0
        self.rotation_y = 0.0
        self.tilt_x = 0.3       # Slight initial tilt for depth perception
        self.rotation_z = 0.0
        self.auto_rotate_speed = 0.4
        self.auto_cycle = True
        self.cycle_timer = 0.0
        self.cycle_duration = 12.0
        self.color_mode_overlay = 2.5  # Brief mode name on startup
        self.label_timer = 0.0
        self.scroll_offset = 0.0
        self._prepare_peptide()

    def _prepare_peptide(self):
        """Pre-compute scale, centering, and calculator values."""
        pep = PEPTIDES[self.peptide_idx]
        coords = pep['coords']
        seq = pep['sequence']

        # Center of mass
        n = len(coords)
        cx = sum(c[0] for c in coords) / n
        cy = sum(c[1] for c in coords) / n
        cz = sum(c[2] for c in coords) / n
        self.center = (cx, cy, cz)

        # Max extent
        max_r = 0.0
        for c in coords:
            dx, dy, dz = c[0] - cx, c[1] - cy, c[2] - cz
            dist = math.sqrt(dx * dx + dy * dy + dz * dz)
            max_r = max(max_r, dist)

        # Scale to fit in upper 48 rows with margin
        # Beads have radius ~2-3, so leave room
        target_radius = 16.0
        self.scale = target_radius / max_r if max_r > 0 else 1.0

        # Calculator values
        self.mw = compute_mw(seq)
        self.charge = compute_charge(seq)
        self.pI = compute_pI(seq)
        self.n_aa = len(seq)

        # Cycling label lines: name → description
        self.labels = [pep['name']]
        if pep.get('description'):
            self.labels.append(pep['description'])

        # Reset timers for new peptide
        self.label_timer = 0.0
        self.scroll_offset = 0.0

    def handle_input(self, input_state) -> bool:
        consumed = False
        rotation_speed = 2.0
        tilt_speed = 1.5

        if input_state.left:
            self.rotation_y -= rotation_speed * 0.016
            self.auto_cycle = False
            consumed = True
        if input_state.right:
            self.rotation_y += rotation_speed * 0.016
            self.auto_cycle = False
            consumed = True
        if input_state.up:
            self.tilt_x -= tilt_speed * 0.016
            self.auto_cycle = False
            consumed = True
        if input_state.down:
            self.tilt_x += tilt_speed * 0.016
            self.auto_cycle = False
            consumed = True

        # Z+X together: cycle color mode
        if input_state.action_l and input_state.action_r:
            self.color_mode_idx = (self.color_mode_idx + 1) % len(COLOR_MODES)
            self.color_mode_overlay = 3.0  # Show legend for 3 seconds
            consumed = True
        elif input_state.action_l:
            self.peptide_idx = (self.peptide_idx - 1) % len(PEPTIDES)
            self.cycle_timer = 0.0
            self.auto_cycle = True
            self._prepare_peptide()
            consumed = True
        elif input_state.action_r:
            self.peptide_idx = (self.peptide_idx + 1) % len(PEPTIDES)
            self.cycle_timer = 0.0
            self.auto_cycle = True
            self._prepare_peptide()
            consumed = True

        return consumed

    def update(self, dt: float):
        self.time += dt
        self.label_timer += dt
        self.scroll_offset += dt * 16  # Scroll speed for long text

        # Auto-rotate
        self.rotation_z += self.auto_rotate_speed * dt

        # Auto-cycle peptides
        if self.auto_cycle:
            self.cycle_timer += dt
            if self.cycle_timer >= self.cycle_duration:
                self.cycle_timer = 0.0
                self.peptide_idx = (self.peptide_idx + 1) % len(PEPTIDES)
                self._prepare_peptide()

        # Color mode overlay countdown
        if self.color_mode_overlay > 0:
            self.color_mode_overlay -= dt

    def _transform_point(self, x, y, z):
        """Apply rotation and project to screen coords in upper 48-row region."""
        x -= self.center[0]
        y -= self.center[1]
        z -= self.center[2]

        x *= self.scale
        y *= self.scale
        z *= self.scale

        # Auto-rotation around Z
        cos_z = math.cos(self.rotation_z)
        sin_z = math.sin(self.rotation_z)
        x1 = x * cos_z - y * sin_z
        y1 = x * sin_z + y * cos_z

        # Manual tilt (X axis)
        cos_t = math.cos(self.tilt_x)
        sin_t = math.sin(self.tilt_x)
        y2 = y1 * cos_t - z * sin_t
        z2 = y1 * sin_t + z * cos_t

        # Manual rotation (Y axis)
        cos_r = math.cos(self.rotation_y)
        sin_r = math.sin(self.rotation_y)
        x2 = x1 * cos_r + z2 * sin_r
        z3 = -x1 * sin_r + z2 * cos_r

        # Project into upper 48 rows, centered
        screen_x = GRID_SIZE // 2 + x2
        screen_y = 22 - y2  # Center vertically in upper region

        return screen_x, screen_y, z3

    def _draw_bead(self, cx, cy, r, color):
        """Draw a shaded sphere (bead) using gradient technique from molecule.py."""
        icx = int(round(cx))
        icy = int(round(cy))
        for dy in range(-r, r + 1):
            for dx in range(-r, r + 1):
                if dx * dx + dy * dy <= r * r:
                    dist = math.sqrt(dx * dx + dy * dy)
                    if dist < r * 0.4:
                        t = dist / (r * 0.4) if r > 0 else 0
                        shade = 1.0 + (1.0 - t) * 0.4
                    else:
                        shade = 1.0 - (dist / r) * 0.3 if r > 0 else 1.0
                    px = icx + dx
                    py = icy + dy
                    if 0 <= px < GRID_SIZE and 0 <= py < 48:
                        c = (
                            min(255, int(color[0] * shade)),
                            min(255, int(color[1] * shade)),
                            min(255, int(color[2] * shade)),
                        )
                        self.display.set_pixel(px, py, c)

    def draw(self):
        self.display.clear(Colors.BLACK)

        pep = PEPTIDES[self.peptide_idx]
        coords = pep['coords']
        seq = pep['sequence']
        mode = COLOR_MODES[self.color_mode_idx]
        bead_colors = get_bead_colors(seq, mode)

        # Transform all points
        transformed = []
        for i, (x, y, z) in enumerate(coords):
            sx, sy, sz = self._transform_point(x, y, z)
            transformed.append((sx, sy, sz, i))

        # Build draw list: beads + bonds, sorted back-to-front by z
        # First collect all drawable items with their z for sorting
        draw_items = []  # (z, type, data)

        # Backbone bonds
        for i in range(len(transformed) - 1):
            sx1, sy1, sz1, _ = transformed[i]
            sx2, sy2, sz2, _ = transformed[i + 1]
            avg_z = (sz1 + sz2) / 2.0
            draw_items.append((avg_z, 'bond', (sx1, sy1, sx2, sy2, avg_z)))

        # Cyclic closure bond (last → first)
        if pep['cyclic'] and len(transformed) > 2:
            sx1, sy1, sz1, _ = transformed[-1]
            sx2, sy2, sz2, _ = transformed[0]
            avg_z = (sz1 + sz2) / 2.0
            draw_items.append((avg_z, 'bond', (sx1, sy1, sx2, sy2, avg_z)))

        # Disulfide bridges
        for i1, i2 in pep.get('disulfide', []):
            if i1 < len(transformed) and i2 < len(transformed):
                sx1, sy1, sz1, _ = transformed[i1]
                sx2, sy2, sz2, _ = transformed[i2]
                avg_z = (sz1 + sz2) / 2.0
                draw_items.append((avg_z, 'disulfide', (sx1, sy1, sx2, sy2)))

        # Beads
        for sx, sy, sz, idx in transformed:
            draw_items.append((sz, 'bead', (sx, sy, sz, idx)))

        # Sort back-to-front (smallest z first = farthest)
        draw_items.sort(key=lambda item: item[0])

        # Draw
        for z_val, item_type, data in draw_items:
            if item_type == 'bond':
                sx1, sy1, sx2, sy2, avg_z = data
                # Depth shading for bonds
                depth = 0.4 + 0.4 * ((avg_z / 20.0) + 0.5)
                depth = max(0.2, min(0.7, depth))
                bc = (int(100 * depth), int(100 * depth), int(110 * depth))
                ix1, iy1 = int(round(sx1)), int(round(sy1))
                ix2, iy2 = int(round(sx2)), int(round(sy2))
                self.display.draw_line(ix1, iy1, ix2, iy2, bc)

            elif item_type == 'disulfide':
                sx1, sy1, sx2, sy2 = data
                # Bright yellow dotted line
                ix1, iy1 = int(round(sx1)), int(round(sy1))
                ix2, iy2 = int(round(sx2)), int(round(sy2))
                dx = ix2 - ix1
                dy = iy2 - iy1
                steps = max(abs(dx), abs(dy), 1)
                for s in range(0, steps + 1, 2):  # Every other pixel = dotted
                    t = s / steps if steps > 0 else 0
                    px = int(ix1 + dx * t)
                    py = int(iy1 + dy * t)
                    if 0 <= px < GRID_SIZE and 0 <= py < 48:
                        self.display.set_pixel(px, py, (255, 220, 40))

            elif item_type == 'bead':
                sx, sy, sz, idx = data
                # Depth-based shading
                depth_factor = 0.5 + 0.5 * ((sz / 20.0) + 0.5)
                depth_factor = max(0.35, min(1.0, depth_factor))
                base_color = bead_colors[idx]
                shaded = (
                    int(base_color[0] * depth_factor),
                    int(base_color[1] * depth_factor),
                    int(base_color[2] * depth_factor),
                )
                # Bead radius: 2 for most, 3 for close beads
                r = 3 if depth_factor > 0.75 else 2
                self._draw_bead(sx, sy, r, shaded)

        # === INFO PANEL (y=48-63): two text lines ===
        self._draw_info_panel(seq, bead_colors)

        # === COLOR MODE NAME (brief overlay at top of 3D area) ===
        if self.color_mode_overlay > 0:
            self._draw_mode_label(mode)

    def _draw_info_panel(self, seq, bead_colors):
        """Draw the info panel in the bottom 16 rows. Two lines only."""
        # Separator line at y=48
        for x in range(GRID_SIZE):
            self.display.set_pixel(x, 48, (40, 40, 50))

        # Line 1 (y=50): Cycling label — name → description → stats
        label_idx = int(self.label_timer / 5.0) % len(self.labels)

        # Reset scroll when label changes
        if not hasattr(self, '_last_label_idx') or self._last_label_idx != label_idx:
            self._last_label_idx = label_idx
            self.scroll_offset = 0.0

        label = self.labels[label_idx]
        self._draw_scrolling_text(2, 50, label, Colors.WHITE)

        # Line 2 (y=57): Colored sequence — each letter matches its bead
        x_pos = 1
        for i, aa in enumerate(seq):
            if x_pos >= GRID_SIZE:
                break
            color = bead_colors[i] if i < len(bead_colors) else (180, 180, 180)
            self.display.draw_text_small(x_pos, 57, aa, color)
            x_pos += 4

    def _draw_scrolling_text(self, x, y, text, color):
        """Draw text, scrolling horizontally if it doesn't fit."""
        max_chars = 15  # ~60px / 4px per char
        if len(text) > max_chars:
            padded = text + "    " + text
            char_w = 4
            total_w = len(text + "    ") * char_w
            offset = int(self.scroll_offset) % total_w
            self.display.draw_text_small(x - offset, y, padded, color)
        else:
            self.display.draw_text_small(x, y, text, color)

    def _draw_mode_label(self, mode):
        """Show the color mode name briefly at top of 3D area."""
        # Fade: full for first 1.5s, fade over last 1s
        if self.color_mode_overlay > 1.0:
            alpha = 1.0
        else:
            alpha = self.color_mode_overlay

        # Mode display names
        mode_names = {
            'PROPERTY': 'BY TYPE',
            'HYDROPATHY': 'HYDROPATHY',
            'CHARGE': 'CHARGE',
        }
        label = mode_names.get(mode, mode)
        c = (int(180 * alpha), int(200 * alpha), int(255 * alpha))
        self.display.draw_text_small(2, 2, label, c)
