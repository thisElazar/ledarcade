"""
Molecule - 3D Ball-and-Stick Molecular Models
==============================================
Rotating 3D models of real molecules with CPK coloring.
Auto-cycles through building blocks of life, organized by group.

Controls:
  Up/Down    - Cycle through groups (ALL, BASICS, DNA, etc.)
  Left/Right - Browse molecules in current group
  Space      - Toggle auto-cycle on/off
"""

import math
import random
from . import Visual, Display, Colors, GRID_SIZE


# CPK atom colors (LED-bright versions)
CPK_COLORS = {
    'H': (255, 255, 255),
    'C': (160, 160, 160),
    'N': (50, 80, 248),
    'O': (255, 30, 30),
    'P': (255, 128, 0),
    'S': (255, 255, 50),
}

CPK_RADIUS = {
    'H': 2,
    'C': 3,
    'N': 3,
    'O': 3,
    'P': 3,
    'S': 3,
}

BOND_COLOR = (100, 100, 100)

# Groups: (key, display_name, color)
GROUPS = [
    ('all', 'ALL', (255, 255, 255)),
    ('basics', 'BASICS', (0, 255, 255)),
    ('dna', 'DNA', (0, 255, 0)),
    ('vitamins', 'VITAMINS', (255, 255, 0)),
    ('neuro', 'NEURO', (255, 0, 255)),
    ('plant', 'PLANT', (128, 255, 0)),
]

# Molecule definitions with real geometry (approximate bond lengths in Angstroms)
MOLECULES = [
    {
        'name': 'WATER',
        'formula': 'H2O',
        'group': 'basics',
        'atoms': [
            ('O', 0.0, 0.0, 0.0),
            ('H', 0.76, 0.59, 0.0),
            ('H', -0.76, 0.59, 0.0),
        ],
        'bonds': [(0, 1, 1), (0, 2, 1)],
    },
    {
        'name': 'CO2',
        'formula': 'CO2',
        'group': 'basics',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('O', -1.16, 0.0, 0.0),
            ('O', 1.16, 0.0, 0.0),
        ],
        'bonds': [(0, 1, 2), (0, 2, 2)],
    },
    {
        'name': 'OXYGEN',
        'formula': 'O2',
        'group': 'basics',
        'atoms': [
            ('O', -0.6, 0.0, 0.0),
            ('O', 0.6, 0.0, 0.0),
        ],
        'bonds': [(0, 1, 2)],
    },
    {
        'name': 'METHANE',
        'formula': 'CH4',
        'group': 'basics',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('H', 0.63, 0.63, 0.63),
            ('H', -0.63, -0.63, 0.63),
            ('H', -0.63, 0.63, -0.63),
            ('H', 0.63, -0.63, -0.63),
        ],
        'bonds': [(0, 1, 1), (0, 2, 1), (0, 3, 1), (0, 4, 1)],
    },
    {
        'name': 'AMMONIA',
        'formula': 'NH3',
        'group': 'basics',
        'atoms': [
            ('N', 0.0, -0.38, 0.0),
            ('H', 0.94, 0.31, 0.0),
            ('H', -0.47, 0.31, 0.81),
            ('H', -0.47, 0.31, -0.81),
        ],
        'bonds': [(0, 1, 1), (0, 2, 1), (0, 3, 1)],
    },
    {
        'name': 'ETHANOL',
        'formula': 'C2H5OH',
        'group': 'basics',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),       # C1 (methyl)
            ('C', 1.52, 0.0, 0.0),       # C2
            ('O', 2.28, 1.09, 0.0),      # O (hydroxyl)
            ('H', -0.51, 0.94, 0.0),     # H on C1
            ('H', -0.51, -0.47, 0.81),   # H on C1
            ('H', -0.51, -0.47, -0.81),  # H on C1
            ('H', 1.88, -0.51, 0.89),    # H on C2
            ('H', 1.88, -0.51, -0.89),   # H on C2
            ('H', 3.18, 0.89, 0.0),      # H on O
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (0, 3, 1), (0, 4, 1),
            (0, 5, 1), (1, 6, 1), (1, 7, 1), (2, 8, 1),
        ],
    },
    {
        'name': 'GLUCOSE',
        'formula': 'C6H12O6',
        'group': 'basics',
        'atoms': [
            # Pyranose ring (6 members: C1-C5 + O)
            ('C', 1.20, 0.0, 0.0),       # C1
            ('C', 0.60, 1.04, 0.0),      # C2
            ('C', -0.60, 1.04, 0.0),     # C3
            ('C', -1.20, 0.0, 0.0),      # C4
            ('C', -0.60, -1.04, 0.0),    # C5
            ('O', 0.60, -1.04, 0.0),     # O (ring)
            # CH2OH on C5
            ('C', -1.10, -2.10, 0.0),    # C6
            # Hydroxyl oxygens
            ('O', 2.10, 0.0, 0.70),      # OH on C1
            ('O', 1.10, 2.00, 0.50),     # OH on C2
            ('O', -1.10, 2.00, -0.50),   # OH on C3
            ('O', -2.10, 0.0, -0.70),    # OH on C4
            ('O', -2.00, -2.80, 0.0),    # OH on C6
            # Hydrogens on ring carbons
            ('H', 1.50, 0.0, -0.90),     # H on C1
            ('H', 0.90, 1.60, -0.85),    # H on C2
            ('H', -0.90, 1.60, 0.85),    # H on C3
            ('H', -1.50, 0.0, 0.90),     # H on C4
            ('H', -0.30, -1.30, 0.90),   # H on C5
            # Hydrogens on C6
            ('H', -0.60, -2.60, 0.85),   # H on C6
            ('H', -0.60, -2.60, -0.85),  # H on C6
            # Hydroxyl H's
            ('H', 2.80, 0.50, 0.40),     # H-O on C1
            ('H', 1.80, 2.30, 0.20),     # H-O on C2
            ('H', -1.80, 2.30, -0.20),   # H-O on C3
            ('H', -2.80, -0.50, -0.40),  # H-O on C4
            ('H', -2.70, -2.50, 0.0),    # H-O on C6
        ],
        'bonds': [
            # Ring
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 4, 1), (4, 5, 1), (5, 0, 1),
            # C5-C6
            (4, 6, 1),
            # C-OH bonds
            (0, 7, 1), (1, 8, 1), (2, 9, 1), (3, 10, 1), (6, 11, 1),
            # C-H bonds
            (0, 12, 1), (1, 13, 1), (2, 14, 1), (3, 15, 1), (4, 16, 1),
            (6, 17, 1), (6, 18, 1),
            # O-H bonds
            (7, 19, 1), (8, 20, 1), (9, 21, 1), (10, 22, 1), (11, 23, 1),
        ],
    },
    {
        'name': 'GLYCINE',
        'formula': 'C2H5NO2',
        'group': 'basics',
        'atoms': [
            ('N', -1.20, -0.50, 0.0),    # amino N
            ('C', 0.0, 0.0, 0.0),        # alpha C
            ('C', 1.30, -0.60, 0.0),     # carboxyl C
            ('O', 1.30, -1.80, 0.0),     # carboxyl O (double)
            ('O', 2.40, 0.10, 0.0),      # carboxyl OH
            ('H', -1.20, -1.50, 0.0),    # H on N
            ('H', -2.00, 0.0, 0.0),      # H on N
            ('H', 0.0, 0.70, 0.85),      # H on alpha C
            ('H', 0.0, 0.70, -0.85),     # H on alpha C
            ('H', 3.20, -0.40, 0.0),     # H on OH
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 2), (2, 4, 1),
            (0, 5, 1), (0, 6, 1), (1, 7, 1), (1, 8, 1), (4, 9, 1),
        ],
    },
    {
        'name': 'ADENINE',
        'formula': 'C5H5N5',
        'group': 'dna',
        'atoms': [
            # Purine double ring (9 members: 5C + 4N)
            ('N', 0.0, 0.0, 0.0),        # N1
            ('C', 1.15, 0.66, 0.0),      # C2
            ('N', 1.15, 2.00, 0.0),      # N3
            ('C', 0.0, 2.70, 0.0),       # C4
            ('C', -1.15, 2.00, 0.0),     # C5
            ('C', -1.15, 0.66, 0.0),     # C6
            # Imidazole ring
            ('N', -2.30, 2.50, 0.0),     # N7
            ('C', -2.30, 3.80, 0.0),     # C8
            ('N', -1.00, 4.10, 0.0),     # N9
            # NH2 on C6
            ('N', -2.30, 0.0, 0.0),      # NH2
            # Hydrogens
            ('H', 2.10, 0.20, 0.0),      # H on C2
            ('H', -3.10, 4.50, 0.0),     # H on C8
            ('H', -0.70, 5.05, 0.0),     # H on N9
            ('H', -2.30, -1.00, 0.0),    # H on NH2
            ('H', -3.20, 0.40, 0.0),     # H on NH2
        ],
        'bonds': [
            # Pyrimidine ring
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            # Imidazole ring
            (4, 6, 1), (6, 7, 2), (7, 8, 1), (8, 3, 1),
            # NH2
            (5, 9, 1),
            # C-H and N-H
            (1, 10, 1), (7, 11, 1), (8, 12, 1), (9, 13, 1), (9, 14, 1),
        ],
    },
    {
        'name': 'THYMINE',
        'formula': 'C5H6N2O2',
        'group': 'dna',
        'atoms': [
            # Pyrimidine ring
            ('N', 0.0, 0.0, 0.0),        # N1
            ('C', 1.15, 0.66, 0.0),      # C2
            ('N', 1.15, 2.00, 0.0),      # N3
            ('C', 0.0, 2.70, 0.0),       # C4
            ('C', -1.15, 2.00, 0.0),     # C5
            ('C', -1.15, 0.66, 0.0),     # C6
            # Carbonyls
            ('O', 2.30, 0.15, 0.0),      # O on C2
            ('O', 0.0, 3.90, 0.0),       # O on C4
            # Methyl on C5
            ('C', -2.40, 2.60, 0.0),     # CH3
            # Hydrogens
            ('H', 0.0, -1.00, 0.0),      # H on N1
            ('H', 2.10, 2.50, 0.0),      # H on N3
            ('H', -2.10, 0.20, 0.0),     # H on C6
            ('H', -3.20, 1.90, 0.0),     # H on CH3
            ('H', -2.60, 3.20, 0.85),    # H on CH3
            ('H', -2.60, 3.20, -0.85),   # H on CH3
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (1, 6, 2), (3, 7, 2),
            (4, 8, 1),
            (0, 9, 1), (2, 10, 1), (5, 11, 1),
            (8, 12, 1), (8, 13, 1), (8, 14, 1),
        ],
    },
    {
        'name': 'GUANINE',
        'formula': 'C5H5N5O',
        'group': 'dna',
        'atoms': [
            # Purine double ring
            ('N', 0.0, 0.0, 0.0),        # N1
            ('C', 1.15, 0.66, 0.0),      # C2
            ('N', 1.15, 2.00, 0.0),      # N3
            ('C', 0.0, 2.70, 0.0),       # C4
            ('C', -1.15, 2.00, 0.0),     # C5
            ('C', -1.15, 0.66, 0.0),     # C6
            # Imidazole ring
            ('N', -2.30, 2.50, 0.0),     # N7
            ('C', -2.30, 3.80, 0.0),     # C8
            ('N', -1.00, 4.10, 0.0),     # N9
            # Carbonyl on C6
            ('O', -2.30, 0.0, 0.0),      # O
            # Amino on C2
            ('N', 2.30, 0.15, 0.0),      # NH2
            # Hydrogens
            ('H', 0.0, -1.00, 0.0),      # H on N1
            ('H', -3.10, 4.50, 0.0),     # H on C8
            ('H', -0.70, 5.05, 0.0),     # H on N9
            ('H', 2.30, -0.85, 0.0),     # H on NH2
            ('H', 3.20, 0.55, 0.0),      # H on NH2
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 2), (2, 3, 1), (3, 4, 2), (4, 5, 1), (5, 0, 1),
            (4, 6, 1), (6, 7, 2), (7, 8, 1), (8, 3, 1),
            (5, 9, 2),
            (1, 10, 1),
            (0, 11, 1), (7, 12, 1), (8, 13, 1), (10, 14, 1), (10, 15, 1),
        ],
    },
    {
        'name': 'CYTOSINE',
        'formula': 'C4H5N3O',
        'group': 'dna',
        'atoms': [
            # Pyrimidine ring
            ('N', 0.0, 0.0, 0.0),        # N1
            ('C', 1.15, 0.66, 0.0),      # C2
            ('N', 1.15, 2.00, 0.0),      # N3
            ('C', 0.0, 2.70, 0.0),       # C4
            ('C', -1.15, 2.00, 0.0),     # C5
            ('C', -1.15, 0.66, 0.0),     # C6
            # Carbonyl on C2
            ('O', 2.30, 0.15, 0.0),      # O
            # Amino on C4
            ('N', 0.0, 3.90, 0.0),       # NH2
            # Hydrogens
            ('H', 0.0, -1.00, 0.0),      # H on N1
            ('H', -2.10, 2.50, 0.0),     # H on C5
            ('H', -2.10, 0.20, 0.0),     # H on C6
            ('H', 0.85, 4.40, 0.0),      # H on NH2
            ('H', -0.85, 4.40, 0.0),     # H on NH2
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (1, 6, 2),
            (3, 7, 1),
            (0, 8, 1), (4, 9, 1), (5, 10, 1), (7, 11, 1), (7, 12, 1),
        ],
    },
    {
        'name': 'ATP',
        'formula': 'C10H16N5O13P3',
        'group': 'dna',
        'atoms': [
            # Adenine base (simplified - key atoms)
            ('N', -6.0, 1.0, 0.0),       # N1
            ('C', -5.2, 1.8, 0.0),       # C2
            ('N', -5.2, 3.0, 0.0),       # N3
            ('C', -6.0, 3.5, 0.0),       # C4
            ('C', -6.8, 2.8, 0.0),       # C5
            ('C', -6.8, 1.6, 0.0),       # C6
            ('N', -7.8, 3.2, 0.0),       # N7
            ('C', -7.8, 4.2, 0.0),       # C8
            ('N', -6.6, 4.5, 0.0),       # N9
            ('N', -7.8, 1.0, 0.0),       # NH2
            # Ribose sugar
            ('C', -5.8, 5.6, 0.0),       # C1'
            ('O', -4.5, 5.3, 0.0),       # O4'
            ('C', -4.0, 6.4, 0.0),       # C2' (was C4')
            ('C', -4.8, 7.2, 0.0),       # C3'
            ('C', -6.1, 6.8, 0.0),       # C4' (was C2')
            ('O', -4.4, 8.4, 0.0),       # O3'
            ('O', -6.8, 7.8, 0.0),       # O2'
            ('C', -2.6, 6.2, 0.0),       # C5'
            ('O', -2.0, 7.2, 0.0),       # O5'
            # Triphosphate chain
            ('P', -0.5, 7.2, 0.0),       # P-alpha
            ('O', -0.2, 8.5, 0.5),       # O on P-alpha
            ('O', -0.2, 6.0, -0.5),      # O on P-alpha
            ('O', 0.8, 7.2, 0.0),        # Bridge O
            ('P', 2.2, 7.2, 0.0),        # P-beta
            ('O', 2.5, 8.5, 0.5),        # O on P-beta
            ('O', 2.5, 6.0, -0.5),       # O on P-beta
            ('O', 3.5, 7.2, 0.0),        # Bridge O
            ('P', 4.9, 7.2, 0.0),        # P-gamma
            ('O', 5.2, 8.5, 0.5),        # O on P-gamma
            ('O', 5.2, 6.0, -0.5),       # O on P-gamma
            ('O', 6.2, 7.2, 0.0),        # Terminal O
            # Key hydrogens (subset for visibility)
            ('H', -4.4, 1.5, 0.0),       # H-C2
            ('H', -8.6, 4.7, 0.0),       # H-C8
            ('H', -7.8, 0.0, 0.0),       # H-NH2
            ('H', -8.7, 1.4, 0.0),       # H-NH2
            ('H', -5.8, 5.6, 0.9),       # H-C1'
            ('H', -2.6, 5.3, 0.7),       # H-C5'
            ('H', -2.6, 5.3, -0.7),      # H-C5'
            # Hydroxyl H's
            ('H', -4.9, 9.0, 0.0),       # H-O3'
            ('H', -7.5, 7.5, 0.0),       # H-O2'
            ('H', 6.8, 7.8, 0.0),        # H terminal OH
            # Phosphate OH H's
            ('H', -0.6, 5.3, -0.8),      # H on P-alpha O
            ('H', 2.1, 5.3, -0.8),       # H on P-beta O
            ('H', 4.8, 5.3, -0.8),       # H on P-gamma O
        ],
        'bonds': [
            # Adenine ring bonds
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (4, 6, 1), (6, 7, 2), (7, 8, 1), (8, 3, 1),
            (5, 9, 1),
            # N9 to ribose
            (8, 10, 1),
            # Ribose ring
            (10, 11, 1), (11, 12, 1), (12, 13, 1), (13, 14, 1), (14, 10, 1),
            # Ribose substituents
            (13, 15, 1), (14, 16, 1), (12, 17, 1), (17, 18, 1),
            # Phosphate chain
            (18, 19, 1), (19, 20, 1), (19, 21, 1), (19, 22, 1),
            (22, 23, 1), (23, 24, 1), (23, 25, 1), (23, 26, 1),
            (26, 27, 1), (27, 28, 1), (27, 29, 1), (27, 30, 1),
            # Hydrogen bonds
            (1, 31, 1), (7, 32, 1), (9, 33, 1), (9, 34, 1),
            (10, 35, 1), (17, 36, 1), (17, 37, 1),
            (15, 38, 1), (16, 39, 1), (30, 40, 1),
            (21, 41, 1), (25, 42, 1), (29, 43, 1),
        ],
    },
    # ── Neuro molecules ──
    {
        'name': 'CAFFEINE',
        'formula': 'C8H10N4O2',
        'group': 'neuro',
        'atoms': [
            ('N', 0.0, 0.0, 0.0),
            ('C', 1.15, 0.66, 0.0),
            ('N', 1.15, 2.0, 0.0),
            ('C', 0.0, 2.7, 0.0),
            ('C', -1.15, 2.0, 0.0),
            ('C', -1.15, 0.66, 0.0),
            ('N', -2.3, 2.5, 0.0),
            ('C', -2.3, 3.8, 0.0),
            ('N', -1.0, 4.1, 0.0),
            ('O', 2.3, 0.15, 0.0),
            ('O', -2.3, 0.15, 0.0),
            ('C', 0.0, -1.4, 0.0),
            ('H', 0.85, -1.9, 0.0),
            ('H', -0.5, -1.9, 0.85),
            ('H', -0.5, -1.9, -0.85),
            ('C', 2.4, 2.6, 0.0),
            ('H', 3.2, 1.9, 0.0),
            ('H', 2.6, 3.2, 0.85),
            ('H', 2.6, 3.2, -0.85),
            ('C', -3.55, 1.8, 0.0),
            ('H', -4.35, 2.5, 0.0),
            ('H', -3.75, 1.2, 0.85),
            ('H', -3.75, 1.2, -0.85),
            ('H', -3.1, 4.5, 0.0),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 4, 2), (4, 5, 1), (5, 0, 1),
            (4, 6, 1), (6, 7, 1), (7, 8, 2), (8, 3, 1), (1, 9, 2), (5, 10, 2),
            (0, 11, 1), (11, 12, 1), (11, 13, 1), (11, 14, 1), (2, 15, 1), (15, 16, 1),
            (15, 17, 1), (15, 18, 1), (6, 19, 1), (19, 20, 1), (19, 21, 1), (19, 22, 1),
            (7, 23, 1),
        ],
    },
    {
        'name': 'DOPAMINE',
        'formula': 'C8H11NO2',
        'group': 'neuro',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('C', 1.2, 0.69, 0.0),
            ('C', 1.2, 2.08, 0.0),
            ('C', 0.0, 2.77, 0.0),
            ('C', -1.2, 2.08, 0.0),
            ('C', -1.2, 0.69, 0.0),
            ('O', 2.4, 2.77, 0.0),
            ('O', 0.0, 4.17, 0.0),
            ('C', 0.0, -1.5, 0.0),
            ('C', 0.0, -2.97, 0.0),
            ('N', 0.0, -4.4, 0.0),
            ('H', 2.13, 0.2, 0.0),
            ('H', -2.13, 2.57, 0.0),
            ('H', -2.13, 0.2, 0.0),
            ('H', 3.1, 2.2, 0.0),
            ('H', 0.85, 4.57, 0.0),
            ('H', 0.89, -1.75, 0.51),
            ('H', -0.89, -1.75, 0.51),
            ('H', 0.89, -3.22, 0.51),
            ('H', -0.89, -3.22, 0.51),
            ('H', 0.85, -4.8, 0.0),
            ('H', -0.85, -4.8, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (2, 6, 1), (3, 7, 1), (0, 8, 1), (8, 9, 1), (9, 10, 1), (1, 11, 1),
            (4, 12, 1), (5, 13, 1), (6, 14, 1), (7, 15, 1), (8, 16, 1), (8, 17, 1),
            (9, 18, 1), (9, 19, 1), (10, 20, 1), (10, 21, 1),
        ],
    },
    {
        'name': 'SEROTONIN',
        'formula': 'C10H12N2O',
        'group': 'neuro',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('C', 1.2, -0.69, 0.0),
            ('C', 2.4, 0.0, 0.0),
            ('C', 2.4, 1.39, 0.0),
            ('C', 1.2, 2.08, 0.0),
            ('C', 0.0, 1.39, 0.0),
            ('C', -1.12, 2.26, 0.0),
            ('C', -2.04, 1.2, 0.0),
            ('N', -1.4, 0.0, 0.0),
            ('O', 3.6, 2.08, 0.0),
            ('C', -1.12, 3.76, 0.0),
            ('C', -1.12, 5.23, 0.0),
            ('N', -1.12, 6.66, 0.0),
            ('H', 1.2, -1.75, 0.0),
            ('H', 3.33, -0.49, 0.0),
            ('H', 1.2, 3.14, 0.0),
            ('H', -2.98, 1.3, 0.0),
            ('H', -1.8, -0.9, 0.0),
            ('H', 4.3, 1.5, 0.0),
            ('H', -0.23, 4.01, 0.51),
            ('H', -2.01, 4.01, 0.51),
            ('H', -0.23, 5.48, 0.51),
            ('H', -2.01, 5.48, 0.51),
            ('H', -0.27, 7.06, 0.0),
            ('H', -1.97, 7.06, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (5, 6, 1), (6, 7, 2), (7, 8, 1), (8, 0, 1), (3, 9, 1), (6, 10, 1),
            (10, 11, 1), (11, 12, 1), (1, 13, 1), (2, 14, 1), (4, 15, 1), (7, 16, 1),
            (8, 17, 1), (9, 18, 1), (10, 19, 1), (10, 20, 1), (11, 21, 1), (11, 22, 1),
            (12, 23, 1), (12, 24, 1),
        ],
    },
    {
        'name': 'ADRENALINE',
        'formula': 'C9H13NO3',
        'group': 'neuro',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('C', 1.2, 0.69, 0.0),
            ('C', 1.2, 2.08, 0.0),
            ('C', 0.0, 2.77, 0.0),
            ('C', -1.2, 2.08, 0.0),
            ('C', -1.2, 0.69, 0.0),
            ('O', 2.4, 2.77, 0.0),
            ('O', 0.0, 4.17, 0.0),
            ('C', 0.0, -1.5, 0.0),
            ('O', 1.2, -2.19, 0.0),
            ('C', 0.0, -2.97, 0.0),
            ('N', 0.0, -4.4, 0.0),
            ('C', 1.2, -5.1, 0.0),
            ('H', 2.13, 0.2, 0.0),
            ('H', -2.13, 2.57, 0.0),
            ('H', -2.13, 0.2, 0.0),
            ('H', 3.1, 2.2, 0.0),
            ('H', 0.85, 4.57, 0.0),
            ('H', -0.89, -1.75, 0.51),
            ('H', 1.9, -1.62, 0.0),
            ('H', 0.89, -3.22, 0.51),
            ('H', -0.89, -3.22, 0.51),
            ('H', -0.85, -4.8, 0.0),
            ('H', 2.05, -4.5, 0.0),
            ('H', 1.4, -5.7, 0.85),
            ('H', 1.4, -5.7, -0.85),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (2, 6, 1), (3, 7, 1), (0, 8, 1), (8, 9, 1), (8, 10, 1), (10, 11, 1),
            (11, 12, 1), (1, 13, 1), (4, 14, 1), (5, 15, 1), (6, 16, 1), (7, 17, 1),
            (8, 18, 1), (9, 19, 1), (10, 20, 1), (10, 21, 1), (11, 22, 1), (12, 23, 1),
            (12, 24, 1), (12, 25, 1),
        ],
    },
    {
        'name': 'TAURINE',
        'formula': 'C2H7NO3S',
        'group': 'neuro',
        'atoms': [
            ('N', 0.0, 0.0, 0.0),
            ('C', 1.47, 0.0, 0.0),
            ('C', 2.2, 1.3, 0.0),
            ('S', 3.67, 1.3, 0.0),
            ('O', 4.4, 0.0, 0.0),
            ('O', 4.4, 2.6, 0.0),
            ('O', 3.67, 1.3, 1.5),
            ('H', -0.45, 0.85, 0.35),
            ('H', -0.45, -0.85, 0.35),
            ('H', 1.85, -0.51, 0.89),
            ('H', 1.85, -0.51, -0.89),
            ('H', 1.82, 1.81, 0.89),
            ('H', 1.82, 1.81, -0.89),
            ('H', 4.3, 1.3, 2.1),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 4, 2), (3, 5, 2), (3, 6, 1),
            (0, 7, 1), (0, 8, 1), (1, 9, 1), (1, 10, 1), (2, 11, 1), (2, 12, 1),
            (6, 13, 1),
        ],
    },
    # ── Plant molecules ──
    {
        'name': 'ETHYLENE',
        'formula': 'C2H4',
        'group': 'plant',
        'atoms': [
            ('C', -0.67, 0.0, 0.0),
            ('C', 0.67, 0.0, 0.0),
            ('H', -1.24, 0.93, 0.0),
            ('H', -1.24, -0.93, 0.0),
            ('H', 1.24, 0.93, 0.0),
            ('H', 1.24, -0.93, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (0, 2, 1), (0, 3, 1), (1, 4, 1), (1, 5, 1),
        ],
    },
    {
        'name': 'PYRUVATE',
        'formula': 'C3H4O3',
        'group': 'plant',
        'atoms': [
            ('C', -2.52, 0.0, 0.0),
            ('C', -1.26, 0.75, 0.0),
            ('O', -1.26, 2.0, 0.0),
            ('C', 0.0, 0.0, 0.0),
            ('O', 0.0, -1.25, 0.0),
            ('O', 1.2, 0.7, 0.0),
            ('H', -3.4, 0.6, 0.0),
            ('H', -2.52, -0.56, 0.89),
            ('H', -2.52, -0.56, -0.89),
            ('H', 1.96, 0.12, 0.0),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 2), (1, 3, 1), (3, 4, 2), (3, 5, 1), (0, 6, 1),
            (0, 7, 1), (0, 8, 1), (5, 9, 1),
        ],
    },
    {
        'name': 'CITRIC ACID',
        'formula': 'C6H8O7',
        'group': 'plant',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('O', 0.0, 1.43, 0.0),
            ('C', 0.0, -0.8, 1.3),
            ('O', 0.0, -2.05, 1.3),
            ('O', 0.0, -0.1, 2.45),
            ('C', -1.5, -0.4, 0.0),
            ('C', -2.6, 0.6, 0.0),
            ('O', -2.6, 1.85, 0.0),
            ('O', -3.75, 0.0, 0.0),
            ('C', 1.5, -0.4, 0.0),
            ('C', 2.6, 0.6, 0.0),
            ('O', 2.6, 1.85, 0.0),
            ('O', 3.75, 0.0, 0.0),
            ('H', 0.0, 2.06, 0.7),
            ('H', 0.0, 0.5, 3.2),
            ('H', -1.6, -1.02, 0.89),
            ('H', -1.6, -1.02, -0.89),
            ('H', -4.48, 0.6, 0.0),
            ('H', 1.6, -1.02, 0.89),
            ('H', 1.6, -1.02, -0.89),
            ('H', 4.48, 0.6, 0.0),
        ],
        'bonds': [
            (0, 1, 1), (0, 2, 1), (2, 3, 2), (2, 4, 1), (0, 5, 1), (5, 6, 1),
            (6, 7, 2), (6, 8, 1), (0, 9, 1), (9, 10, 1), (10, 11, 2), (10, 12, 1),
            (1, 13, 1), (4, 14, 1), (5, 15, 1), (5, 16, 1), (8, 17, 1), (9, 18, 1),
            (9, 19, 1), (12, 20, 1),
        ],
    },
    {
        'name': 'AUXIN',
        'formula': 'C10H9NO2',
        'group': 'plant',
        'atoms': [
            ('C', 0.0, 0.0, 0.0),
            ('C', 1.2, 0.7, 0.0),
            ('C', 1.2, 2.1, 0.0),
            ('C', 0.0, 2.8, 0.0),
            ('C', -1.2, 2.1, 0.0),
            ('C', -1.2, 0.7, 0.0),
            ('C', -2.1, -0.3, 0.0),
            ('C', -1.5, -1.5, 0.0),
            ('N', -0.15, -1.4, 0.0),
            ('C', -3.55, -0.1, 0.0),
            ('C', -4.3, -1.2, 0.0),
            ('O', -3.8, -2.35, 0.0),
            ('O', -5.55, -1.0, 0.0),
            ('H', 2.15, 0.18, 0.0),
            ('H', 2.15, 2.62, 0.0),
            ('H', 0.0, 3.88, 0.0),
            ('H', -2.15, 2.62, 0.0),
            ('H', -1.95, -2.42, 0.0),
            ('H', 0.44, -2.2, 0.0),
            ('H', -3.8, 0.5, 0.89),
            ('H', -3.8, 0.5, -0.89),
            ('H', -6.1, -1.78, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (5, 6, 1), (6, 7, 2), (7, 8, 1), (8, 0, 1), (6, 9, 1), (9, 10, 1),
            (10, 11, 2), (10, 12, 1), (1, 13, 1), (2, 14, 1), (3, 15, 1), (4, 16, 1),
            (7, 17, 1), (8, 18, 1), (9, 19, 1), (9, 20, 1), (12, 21, 1),
        ],
    },
    # ── Penicillin ──
    {
        'name': 'PENICILLIN',
        'formula': 'C16H18N2O4S',
        'group': 'basics',
        'atoms': [
            ('N', 0.0, 0.0, 0.0),
            ('C', 1.2, 0.7, 0.0),
            ('C', 1.0, 2.1, 0.0),
            ('C', -0.4, 1.5, 0.0),
            ('O', 1.8, 3.05, 0.0),
            ('S', -1.6, 1.6, 0.8),
            ('C', -1.6, 0.0, 1.6),
            ('C', -0.5, -0.6, 1.0),
            ('C', -2.9, -0.8, 1.6),
            ('C', -1.6, 0.5, 3.0),
            ('C', -0.6, -2.05, 1.4),
            ('O', -1.5, -2.7, 1.8),
            ('O', 0.5, -2.65, 1.1),
            ('N', 2.4, 0.1, -0.5),
            ('C', 3.5, 0.8, -0.8),
            ('O', 3.5, 2.0, -0.8),
            ('C', 4.7, 0.0, -1.2),
            ('C', 5.9, 0.8, -1.5),
            ('C', 5.9, 2.1, -2.0),
            ('C', 7.1, 2.8, -2.3),
            ('C', 8.3, 2.2, -2.1),
            ('C', 8.3, 0.9, -1.6),
            ('C', 7.1, 0.2, -1.3),
            ('H', 1.6, 0.5, -0.95),
            ('H', -0.6, 1.8, -0.95),
            ('H', -0.15, -0.6, 1.95),
            ('H', 2.5, -0.85, -0.5),
            ('H', 5.0, 2.55, -2.15),
            ('H', 7.1, 3.8, -2.65),
            ('H', 9.25, 2.75, -2.35),
            ('H', 9.25, 0.45, -1.45),
            ('H', 7.1, -0.8, -0.95),
            ('H', 4.5, -0.65, -2.05),
            ('H', 4.9, -0.65, -0.35),
            ('H', -3.75, -0.25, 1.25),
            ('H', -2.8, -1.5, 0.8),
            ('H', -3.1, -1.25, 2.5),
            ('H', -0.75, 1.05, 3.3),
            ('H', -2.45, 1.1, 3.15),
            ('H', -1.6, -0.35, 3.65),
            ('H', 0.45, -3.55, 1.4),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 0, 1), (2, 4, 2), (0, 7, 1),
            (7, 5, 1), (5, 6, 1), (6, 3, 1), (6, 8, 1), (6, 9, 1), (7, 10, 1),
            (10, 11, 2), (10, 12, 1), (1, 13, 1), (13, 14, 1), (14, 15, 2), (14, 16, 1),
            (16, 17, 1), (17, 18, 2), (18, 19, 1), (19, 20, 2), (20, 21, 1), (21, 22, 2),
            (22, 17, 1), (1, 23, 1), (3, 24, 1), (7, 25, 1), (13, 26, 1), (18, 27, 1),
            (19, 28, 1), (20, 29, 1), (21, 30, 1), (22, 31, 1), (16, 32, 1), (16, 33, 1),
            (8, 34, 1), (8, 35, 1), (8, 36, 1), (9, 37, 1), (9, 38, 1), (9, 39, 1),
            (12, 40, 1),
        ],
    },
    # ── Vitamins ──
    {
        'name': 'VITAMIN C',
        'formula': 'C6H8O6',
        'group': 'vitamins',
        'atoms': [
            ('O', 0.9, 0.8, 0.0),
            ('C', 0.0, 1.6, 0.0),
            ('C', -1.05, 0.8, 0.0),
            ('C', -0.65, -0.6, 0.0),
            ('C', 0.65, -0.6, 0.3),
            ('O', 0.1, 2.8, 0.0),
            ('O', -2.2, 1.3, 0.0),
            ('O', -1.5, -1.5, 0.0),
            ('C', 1.5, -1.6, 0.6),
            ('O', 0.9, -2.8, 0.3),
            ('C', 2.9, -1.4, 0.4),
            ('O', 3.6, -2.4, 0.7),
            ('H', -2.9, 0.7, 0.0),
            ('H', -1.3, -2.4, 0.0),
            ('H', 1.0, -0.55, 1.3),
            ('H', 1.6, -1.7, 1.65),
            ('H', 0.2, -3.3, 0.6),
            ('H', 3.4, -0.5, 0.7),
            ('H', 3.1, -1.4, -0.65),
            ('H', 4.5, -2.2, 0.5),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 0, 1), (1, 5, 2),
            (2, 6, 1), (3, 7, 1), (4, 8, 1), (8, 10, 1), (8, 9, 1), (10, 11, 1),
            (6, 12, 1), (7, 13, 1), (4, 14, 1), (8, 15, 1), (9, 16, 1), (10, 17, 1),
            (10, 18, 1), (11, 19, 1),
        ],
    },
    {
        'name': 'VITAMIN B3',
        'formula': 'C6H5NO2',
        'group': 'vitamins',
        'atoms': [
            ('N', 0.0, 1.4, 0.0),
            ('C', 1.21, 0.7, 0.0),
            ('C', 1.21, -0.7, 0.0),
            ('C', 0.0, -1.4, 0.0),
            ('C', -1.21, -0.7, 0.0),
            ('C', -1.21, 0.7, 0.0),
            ('C', 2.5, -1.4, 0.0),
            ('O', 2.5, -2.6, 0.0),
            ('O', 3.6, -0.7, 0.0),
            ('H', 2.15, 1.2, 0.0),
            ('H', 0.0, -2.5, 0.0),
            ('H', -2.15, -1.2, 0.0),
            ('H', -2.15, 1.2, 0.0),
            ('H', 4.4, -1.2, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (2, 6, 1), (6, 7, 2), (6, 8, 1), (1, 9, 1), (3, 10, 1), (4, 11, 1),
            (5, 12, 1), (8, 13, 1),
        ],
    },
    {
        'name': 'VITAMIN B6',
        'formula': 'C8H11NO3',
        'group': 'vitamins',
        'atoms': [
            ('N', 0.0, 1.4, 0.0),
            ('C', 1.21, 0.7, 0.0),
            ('C', 1.21, -0.7, 0.0),
            ('C', 0.0, -1.4, 0.0),
            ('C', -1.21, -0.7, 0.0),
            ('C', -1.21, 0.7, 0.0),
            ('C', 2.5, 1.4, 0.0),
            ('O', 2.4, -1.2, 0.0),
            ('C', 0.0, -2.9, 0.0),
            ('O', 1.1, -3.6, 0.0),
            ('C', -2.5, -1.4, 0.0),
            ('O', -2.5, -2.7, 0.0),
            ('H', -2.15, 1.2, 0.0),
            ('H', 3.3, 0.8, 0.0),
            ('H', 2.6, 2.0, 0.85),
            ('H', 2.6, 2.0, -0.85),
            ('H', 3.2, -0.7, 0.0),
            ('H', -0.85, -3.3, 0.5),
            ('H', 0.1, -3.2, -1.0),
            ('H', 1.0, -4.5, 0.0),
            ('H', -3.4, -0.9, 0.4),
            ('H', -2.6, -1.4, -1.05),
            ('H', -3.3, -3.2, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (1, 6, 1), (2, 7, 1), (3, 8, 1), (8, 9, 1), (4, 10, 1), (10, 11, 1),
            (5, 12, 1), (6, 13, 1), (6, 14, 1), (6, 15, 1), (7, 16, 1), (8, 17, 1),
            (8, 18, 1), (9, 19, 1), (10, 20, 1), (10, 21, 1), (11, 22, 1),
        ],
    },
    {
        'name': 'VITAMIN B1',
        'formula': 'C12H17N4OS',
        'group': 'vitamins',
        'atoms': [
            ('N', -4.2, 0.7, 0.0),
            ('C', -3.0, 1.4, 0.0),
            ('N', -1.8, 0.7, 0.0),
            ('C', -1.8, -0.7, 0.0),
            ('C', -3.0, -1.4, 0.0),
            ('C', -4.2, -0.7, 0.0),
            ('C', -3.0, 2.9, 0.0),
            ('N', -0.6, -1.3, 0.0),
            ('C', -3.0, -2.9, 0.0),
            ('N', -1.6, -3.5, 0.0),
            ('C', -0.6, -2.7, 0.3),
            ('S', -0.4, -4.3, 0.0),
            ('C', -1.6, -5.0, 0.0),
            ('C', -2.5, -4.2, 0.0),
            ('C', -3.8, -4.6, 0.0),
            ('C', -1.5, -6.4, 0.0),
            ('C', -0.3, -7.2, 0.0),
            ('O', -0.2, -8.5, 0.0),
            ('H', -5.15, 1.2, 0.0),
            ('H', -3.6, 3.3, 0.85),
            ('H', -3.6, 3.3, -0.85),
            ('H', -2.0, 3.3, 0.0),
            ('H', -0.6, -0.7, 0.85),
            ('H', 0.2, -1.8, 0.0),
            ('H', -3.85, -3.3, 0.5),
            ('H', -3.1, -3.2, -1.0),
            ('H', 0.1, -2.1, 0.6),
            ('H', -4.5, -3.8, 0.0),
            ('H', -3.9, -5.2, 0.85),
            ('H', -3.9, -5.2, -0.85),
            ('H', -2.4, -6.8, 0.4),
            ('H', -1.4, -6.6, -1.05),
            ('H', 0.55, -6.8, 0.4),
            ('H', -0.25, -7.0, -1.05),
            ('H', 0.6, -8.9, 0.0),
        ],
        'bonds': [
            (0, 1, 2), (1, 2, 1), (2, 3, 2), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (1, 6, 1), (3, 7, 1), (4, 8, 1), (8, 9, 1), (9, 10, 2), (10, 11, 1),
            (11, 12, 1), (12, 13, 2), (13, 9, 1), (13, 14, 1), (12, 15, 1), (15, 16, 1),
            (16, 17, 1), (5, 18, 1), (6, 19, 1), (6, 20, 1), (6, 21, 1), (7, 22, 1),
            (7, 23, 1), (8, 24, 1), (8, 25, 1), (10, 26, 1), (14, 27, 1), (14, 28, 1),
            (14, 29, 1), (15, 30, 1), (15, 31, 1), (16, 32, 1), (16, 33, 1), (17, 34, 1),
        ],
    },
    {
        'name': 'VITAMIN B2',
        'formula': 'C17H20N4O6',
        'group': 'vitamins',
        'atoms': [
            ('N', 3.6, 0.7, 0.0),
            ('C', 2.4, 1.4, 0.0),
            ('N', 1.2, 0.7, 0.0),
            ('C', 1.2, -0.7, 0.0),
            ('C', 2.4, -1.4, 0.0),
            ('C', 3.6, -0.7, 0.0),
            ('O', 2.4, 2.6, 0.0),
            ('O', 0.0, -1.3, 0.0),
            ('N', 2.4, -2.8, 0.0),
            ('C', 3.6, -3.5, 0.0),
            ('C', 4.8, -2.8, 0.0),
            ('N', 4.8, -1.4, 0.0),
            ('C', 3.6, -4.9, 0.0),
            ('C', 4.8, -5.6, 0.0),
            ('C', 6.0, -4.9, 0.0),
            ('C', 6.0, -3.5, 0.0),
            ('C', 4.8, -7.1, 0.0),
            ('C', 7.2, -5.6, 0.0),
            ('C', 6.0, -0.7, 0.0),
            ('C', 7.3, -1.3, 0.3),
            ('O', 7.3, -2.6, 0.8),
            ('C', 8.6, -0.6, 0.0),
            ('O', 8.6, 0.7, 0.5),
            ('C', 9.9, -1.3, 0.3),
            ('O', 9.9, -2.6, 0.8),
            ('C', 11.2, -0.6, 0.0),
            ('O', 12.3, -1.3, 0.3),
            ('H', 0.4, 1.2, 0.0),
            ('H', 12.9, -0.8, 0.6),
            ('H', 2.7, -5.4, 0.0),
            ('H', 6.9, -3.0, 0.0),
            ('H', 4.8, -7.5, 1.0),
            ('H', 5.6, -7.5, -0.5),
            ('H', 3.9, -7.5, -0.5),
            ('H', 7.2, -6.0, 1.0),
            ('H', 8.0, -5.1, -0.5),
            ('H', 7.3, -6.4, -0.5),
            ('H', 5.9, -0.3, 1.0),
            ('H', 6.1, 0.1, -0.7),
            ('H', 7.4, -1.1, 1.35),
            ('H', 7.8, -3.1, 0.5),
            ('H', 8.7, -0.4, -1.05),
            ('H', 9.4, 1.1, 0.3),
            ('H', 10.0, -1.1, 1.35),
            ('H', 10.4, -3.1, 0.5),
            ('H', 11.3, -0.4, -1.05),
            ('H', 11.1, 0.2, 0.7),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 4, 1), (4, 5, 1), (5, 0, 2),
            (1, 6, 2), (3, 7, 2), (4, 8, 2), (8, 9, 1), (9, 10, 1), (10, 11, 1),
            (11, 5, 1), (9, 12, 2), (12, 13, 1), (13, 14, 2), (14, 15, 1), (15, 10, 2),
            (13, 16, 1), (14, 17, 1), (11, 18, 1), (18, 19, 1), (19, 20, 1), (19, 21, 1),
            (21, 22, 1), (21, 23, 1), (23, 24, 1), (23, 25, 1), (25, 26, 1), (2, 27, 1),
            (26, 28, 1), (12, 29, 1), (15, 30, 1), (16, 31, 1), (16, 32, 1), (16, 33, 1),
            (17, 34, 1), (17, 35, 1), (17, 36, 1), (18, 37, 1), (18, 38, 1), (19, 39, 1),
            (20, 40, 1), (21, 41, 1), (22, 42, 1), (23, 43, 1), (24, 44, 1), (25, 45, 1),
            (25, 46, 1),
        ],
    },
    {
        'name': 'VITAMIN B7',
        'formula': 'C10H16N2O3S',
        'group': 'vitamins',
        'atoms': [
            ('C', 0.0, 1.2, 0.0),
            ('O', 0.0, 2.4, 0.0),
            ('N', -1.1, 0.5, 0.0),
            ('N', 1.1, 0.5, 0.0),
            ('C', -0.7, -0.85, 0.3),
            ('C', 0.7, -0.85, 0.3),
            ('C', -1.6, -1.8, 0.0),
            ('S', -0.8, -3.2, 0.0),
            ('C', 0.8, -2.8, 0.0),
            ('C', 1.6, -1.0, -0.8),
            ('C', 2.8, -1.8, -1.1),
            ('C', 3.6, -1.1, -2.2),
            ('C', 4.8, -1.9, -2.5),
            ('C', 5.6, -1.2, -3.6),
            ('O', 5.4, 0.0, -3.9),
            ('O', 6.5, -1.9, -4.2),
            ('H', -2.0, 0.8, 0.0),
            ('H', 2.0, 0.8, 0.0),
            ('H', -0.8, -0.9, 1.35),
            ('H', -2.55, -1.5, 0.5),
            ('H', -1.9, -1.8, -1.05),
            ('H', 1.3, -3.3, 0.85),
            ('H', 1.2, -3.2, -0.9),
            ('H', 1.9, -0.2, -1.5),
            ('H', 1.1, -0.6, -1.6),
            ('H', 2.5, -2.8, -1.4),
            ('H', 3.4, -1.9, -0.3),
            ('H', 3.9, -0.1, -1.9),
            ('H', 3.0, -1.0, -3.0),
            ('H', 5.1, -2.0, -1.6),
            ('H', 4.5, -2.9, -2.8),
            ('H', 7.1, -1.4, -4.9),
        ],
        'bonds': [
            (0, 2, 1), (2, 4, 1), (4, 5, 1), (5, 3, 1), (3, 0, 1), (0, 1, 2),
            (4, 6, 1), (6, 7, 1), (7, 8, 1), (8, 5, 1), (5, 9, 1), (9, 10, 1),
            (10, 11, 1), (11, 12, 1), (12, 13, 1), (13, 14, 2), (13, 15, 1), (2, 16, 1),
            (3, 17, 1), (4, 18, 1), (6, 19, 1), (6, 20, 1), (8, 21, 1), (8, 22, 1),
            (9, 23, 1), (9, 24, 1), (10, 25, 1), (10, 26, 1), (11, 27, 1), (11, 28, 1),
            (12, 29, 1), (12, 30, 1), (15, 31, 1),
        ],
    },
    {
        'name': 'VITAMIN B9',
        'formula': 'C19H19N7O6',
        'group': 'vitamins',
        'atoms': [
            ('N', -7.8, 1.4, 0.0),
            ('C', -6.6, 2.1, 0.0),
            ('N', -5.4, 1.4, 0.0),
            ('C', -5.4, 0.0, 0.0),
            ('C', -6.6, -0.7, 0.0),
            ('C', -7.8, 0.0, 0.0),
            ('N', -6.6, 3.4, 0.0),
            ('O', -4.3, -0.6, 0.0),
            ('N', -6.6, -2.1, 0.0),
            ('C', -7.8, -2.8, 0.0),
            ('C', -9.0, -2.1, 0.0),
            ('N', -9.0, -0.7, 0.0),
            ('C', -7.8, -4.3, 0.0),
            ('N', -6.6, -5.0, 0.0),
            ('C', -5.4, -4.3, 0.0),
            ('C', -4.2, -5.0, 0.0),
            ('C', -3.0, -4.3, 0.0),
            ('C', -3.0, -2.9, 0.0),
            ('C', -4.2, -2.2, 0.0),
            ('C', -5.4, -2.9, 0.0),
            ('C', -1.8, -2.2, 0.0),
            ('O', -1.8, -0.9, 0.0),
            ('N', -0.6, -2.9, 0.0),
            ('C', 0.6, -2.2, 0.0),
            ('C', 0.6, -0.8, 0.0),
            ('O', -0.4, -0.1, 0.0),
            ('O', 1.8, -0.2, 0.0),
            ('C', 1.9, -2.9, 0.0),
            ('C', 3.2, -2.2, 0.0),
            ('C', 4.5, -2.9, 0.0),
            ('O', 4.5, -4.1, 0.0),
            ('O', 5.6, -2.2, 0.0),
            ('H', -5.8, 3.9, 0.0),
            ('H', -7.4, 3.9, 0.0),
            ('H', -9.9, -2.6, 0.0),
            ('H', -8.3, -4.7, 0.85),
            ('H', -8.3, -4.7, -0.85),
            ('H', -6.6, -6.0, 0.0),
            ('H', -4.2, -6.0, 0.0),
            ('H', -2.1, -4.8, 0.0),
            ('H', -4.2, -1.2, 0.0),
            ('H', -6.3, -2.4, 0.0),
            ('H', -0.6, -3.9, 0.0),
            ('H', 0.6, -2.4, 1.05),
            ('H', 1.8, 0.7, 0.0),
            ('H', 1.9, -3.5, 0.85),
            ('H', 1.9, -3.5, -0.85),
            ('H', 3.2, -1.6, 0.85),
            ('H', 3.2, -1.6, -0.85),
            ('H', 6.3, -2.7, 0.0),
            ('H', -8.7, 1.9, 0.0),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 2), (2, 3, 1), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (1, 6, 1), (3, 7, 2), (4, 8, 1), (8, 9, 2), (9, 10, 1), (10, 11, 2),
            (11, 5, 1), (9, 12, 1), (12, 13, 1), (13, 14, 1), (14, 15, 2), (15, 16, 1),
            (16, 17, 2), (17, 18, 1), (18, 19, 2), (19, 14, 1), (17, 20, 1), (20, 21, 2),
            (20, 22, 1), (22, 23, 1), (23, 24, 1), (24, 25, 2), (24, 26, 1), (23, 27, 1),
            (27, 28, 1), (28, 29, 1), (29, 30, 2), (29, 31, 1), (6, 32, 1), (6, 33, 1),
            (10, 34, 1), (12, 35, 1), (12, 36, 1), (13, 37, 1), (15, 38, 1), (16, 39, 1),
            (18, 40, 1), (19, 41, 1), (22, 42, 1), (23, 43, 1), (26, 44, 1), (27, 45, 1),
            (27, 46, 1), (28, 47, 1), (28, 48, 1), (31, 49, 1), (0, 50, 1),
        ],
    },
    {
        'name': 'VITAMIN A',
        'formula': 'C20H30O',
        'group': 'vitamins',
        'atoms': [
            ('C', -7.0, 0.0, 0.0),
            ('C', -6.2, 1.2, 0.0),
            ('C', -4.8, 1.2, 0.0),
            ('C', -4.0, 0.0, 0.0),
            ('C', -4.8, -1.2, 0.0),
            ('C', -6.2, -1.2, 0.0),
            ('C', -7.8, 0.2, 1.2),
            ('C', -7.8, 0.2, -1.2),
            ('C', -4.3, -2.5, 0.0),
            ('C', -6.9, -2.4, 0.0),
            ('C', -6.5, -3.7, 0.0),
            ('C', -7.2, -4.9, 0.0),
            ('C', -8.6, -5.0, 0.0),
            ('C', -6.5, -6.1, 0.0),
            ('C', -7.0, -7.4, 0.0),
            ('C', -6.2, -8.5, 0.0),
            ('C', -6.7, -9.8, 0.0),
            ('C', -8.1, -10.1, 0.0),
            ('C', -5.9, -10.9, 0.0),
            ('C', -6.4, -12.2, 0.0),
            ('O', -5.6, -13.3, 0.0),
            ('H', -6.7, 1.7, 0.85),
            ('H', -6.7, 1.7, -0.85),
            ('H', -4.3, 1.7, 0.85),
            ('H', -4.3, 1.7, -0.85),
            ('H', -3.2, 0.3, 0.85),
            ('H', -3.2, 0.3, -0.85),
            ('H', -8.5, -0.5, 1.3),
            ('H', -8.3, 1.1, 1.2),
            ('H', -7.2, 0.1, 2.05),
            ('H', -8.5, -0.5, -1.3),
            ('H', -8.3, 1.1, -1.2),
            ('H', -7.2, 0.1, -2.05),
            ('H', -4.8, -3.1, 0.85),
            ('H', -4.8, -3.1, -0.85),
            ('H', -3.3, -2.5, 0.0),
            ('H', -7.9, -2.3, 0.0),
            ('H', -5.5, -3.8, 0.0),
            ('H', -5.5, -6.0, 0.0),
            ('H', -8.0, -7.5, 0.0),
            ('H', -5.2, -8.4, 0.0),
            ('H', -4.9, -10.8, 0.0),
            ('H', -7.4, -12.3, 0.0),
            ('H', -9.1, -4.1, 0.0),
            ('H', -9.0, -5.5, 0.85),
            ('H', -9.0, -5.5, -0.85),
            ('H', -8.6, -9.2, 0.0),
            ('H', -8.5, -10.6, 0.85),
            ('H', -8.5, -10.6, -0.85),
            ('H', -5.9, -14.1, 0.0),
            ('H', -6.0, -12.7, 0.85),
        ],
        'bonds': [
            (0, 1, 1), (1, 2, 1), (2, 3, 1), (3, 4, 1), (4, 5, 2), (5, 0, 1),
            (0, 6, 1), (0, 7, 1), (4, 8, 1), (5, 9, 1), (9, 10, 2), (10, 11, 1),
            (11, 13, 2), (13, 14, 1), (14, 15, 2), (15, 16, 1), (16, 18, 2), (18, 19, 1),
            (11, 12, 1), (16, 17, 1), (19, 20, 1), (1, 21, 1), (1, 22, 1), (2, 23, 1),
            (2, 24, 1), (3, 25, 1), (3, 26, 1), (6, 27, 1), (6, 28, 1), (6, 29, 1),
            (7, 30, 1), (7, 31, 1), (7, 32, 1), (8, 33, 1), (8, 34, 1), (8, 35, 1),
            (9, 36, 1), (10, 37, 1), (13, 38, 1), (14, 39, 1), (15, 40, 1), (18, 41, 1),
            (19, 42, 1), (12, 43, 1), (12, 44, 1), (12, 45, 1), (17, 46, 1), (17, 47, 1),
            (17, 48, 1), (20, 49, 1), (19, 50, 1),
        ],
    },
]


def _build_group_indices():
    """Build mapping from group key to list of MOLECULES indices."""
    groups = {}
    for i, mol in enumerate(MOLECULES):
        g = mol.get('group', 'basics')
        groups.setdefault(g, []).append(i)
    groups['all'] = list(range(len(MOLECULES)))
    return groups


class Molecule(Visual):
    name = "MOLECULES"
    description = "3D ball-and-stick molecular models"
    category = "science"

    def __init__(self, display: Display):
        super().__init__(display)

    def reset(self):
        self.time = 0.0
        self.group_indices = _build_group_indices()
        self.group_idx = 0  # Index into GROUPS (starts on ALL)
        self.mol_pos = random.randint(0, len(MOLECULES) - 1)
        self.rotation_y = 0.0
        self.rotation_speed = 0.6
        self.tilt_phase = 0.0
        self.auto_cycle = True
        self.cycle_timer = 0.0
        self.cycle_duration = 8.0
        self.overlay_timer = 0.0  # Group name overlay countdown
        self.label_timer = 0.0    # Time since current molecule loaded
        self._prepare_molecule()

    def _current_mol_list(self):
        """Get list of molecule indices for current group."""
        key = GROUPS[self.group_idx][0]
        return self.group_indices.get(key, [])

    def _current_mol_index(self):
        """Get the global MOLECULES index for the current selection."""
        mol_list = self._current_mol_list()
        if not mol_list:
            return 0
        return mol_list[self.mol_pos % len(mol_list)]

    def _prepare_molecule(self):
        """Pre-compute scale and centering for current molecule."""
        mol = MOLECULES[self._current_mol_index()]
        atoms = mol['atoms']

        if len(atoms) == 0:
            self.scale = 1.0
            self.offset = (0, 0, 0)
            return

        cx = sum(a[1] for a in atoms) / len(atoms)
        cy = sum(a[2] for a in atoms) / len(atoms)
        cz = sum(a[3] for a in atoms) / len(atoms)
        self.offset = (cx, cy, cz)

        max_r = 0.0
        for a in atoms:
            dx, dy, dz = a[1] - cx, a[2] - cy, a[3] - cz
            r = math.sqrt(dx * dx + dy * dy + dz * dz)
            max_r = max(max_r, r)

        target_radius = 22.0
        self.scale = target_radius / max_r if max_r > 0 else 10.0
        self.large = len(atoms) > 15
        self.label_timer = 0.0

    def handle_input(self, input_state) -> bool:
        consumed = False

        if input_state.up_pressed:
            self.group_idx = (self.group_idx - 1) % len(GROUPS)
            self.mol_pos = 0
            self.cycle_timer = 0.0
            self.overlay_timer = 2.5
            self._prepare_molecule()
            consumed = True
        if input_state.down_pressed:
            self.group_idx = (self.group_idx + 1) % len(GROUPS)
            self.mol_pos = 0
            self.cycle_timer = 0.0
            self.overlay_timer = 2.5
            self._prepare_molecule()
            consumed = True
        if input_state.left_pressed:
            mol_list = self._current_mol_list()
            if mol_list:
                self.mol_pos = (self.mol_pos - 1) % len(mol_list)
            self.cycle_timer = 0.0
            self._prepare_molecule()
            consumed = True
        if input_state.right_pressed:
            mol_list = self._current_mol_list()
            if mol_list:
                self.mol_pos = (self.mol_pos + 1) % len(mol_list)
            self.cycle_timer = 0.0
            self._prepare_molecule()
            consumed = True
        if input_state.action_l or input_state.action_r:
            self.auto_cycle = not self.auto_cycle
            consumed = True

        return consumed

    def update(self, dt: float):
        self.time += dt
        self.label_timer += dt
        self.rotation_y += self.rotation_speed * dt
        self.tilt_phase += dt * 0.4

        if self.overlay_timer > 0:
            self.overlay_timer = max(0.0, self.overlay_timer - dt)

        if self.auto_cycle:
            self.cycle_timer += dt
            if self.cycle_timer >= self.cycle_duration:
                self.cycle_timer = 0.0
                mol_list = self._current_mol_list()
                if mol_list:
                    self.mol_pos = (self.mol_pos + 1) % len(mol_list)
                self._prepare_molecule()

    def _transform_point(self, x, y, z):
        """Apply rotation and project to screen coords."""
        x -= self.offset[0]
        y -= self.offset[1]
        z -= self.offset[2]
        x *= self.scale
        y *= self.scale
        z *= self.scale

        tilt = 0.26 * math.sin(self.tilt_phase)
        cos_t, sin_t = math.cos(tilt), math.sin(tilt)
        y2 = y * cos_t - z * sin_t
        z2 = y * sin_t + z * cos_t

        cos_r, sin_r = math.cos(self.rotation_y), math.sin(self.rotation_y)
        x2 = x * cos_r + z2 * sin_r
        z3 = -x * sin_r + z2 * cos_r

        screen_x = GRID_SIZE // 2 + x2
        screen_y = 28 - y2
        return screen_x, screen_y, z3

    def draw(self):
        self.display.clear(Colors.BLACK)

        mol = MOLECULES[self._current_mol_index()]
        atoms = mol['atoms']
        bonds = mol['bonds']

        transformed = []
        for elem, ax, ay, az in atoms:
            sx, sy, sz = self._transform_point(ax, ay, az)
            transformed.append((elem, sx, sy, sz))

        draw_list = []

        for a_idx, b_idx, order in bonds:
            e1, x1, y1, z1 = transformed[a_idx]
            e2, x2, y2, z2 = transformed[b_idx]
            avg_z = (z1 + z2) / 2
            draw_list.append(('bond', avg_z, x1, y1, x2, y2, order))

        for i, (elem, sx, sy, sz) in enumerate(transformed):
            r = CPK_RADIUS.get(elem, 3)
            if self.large:
                r = max(1, r - 1)
            color = CPK_COLORS.get(elem, (200, 200, 200))
            draw_list.append(('atom', sz, sx, sy, r, color, elem))

        draw_list.sort(key=lambda item: item[1])

        for item in draw_list:
            if item[0] == 'bond':
                _, _, x1, y1, x2, y2, order = item
                self._draw_bond(x1, y1, x2, y2, order)
            else:
                _, _, sx, sy, r, color, elem = item
                self._draw_atom(sx, sy, r, color)

        # Bottom label: common name first 4s, then formula for 4s, repeat
        if int(self.label_timer / 4) % 2 == 0:
            label = mol['name']
        else:
            label = mol['formula']
        self.display.draw_text_small(2, 58, label, Colors.WHITE)

        # Group name overlay at top (fades after switching groups)
        if self.overlay_timer > 0:
            _, gname, gcolor = GROUPS[self.group_idx]
            alpha = min(1.0, self.overlay_timer / 0.5)
            oc = (int(gcolor[0] * alpha), int(gcolor[1] * alpha),
                  int(gcolor[2] * alpha))
            self.display.draw_text_small(2, 2, gname, oc)

    def _draw_atom(self, cx, cy, r, color):
        """Draw a filled circle for an atom with simple shading."""
        icx = int(round(cx))
        icy = int(round(cy))

        for dy in range(-r, r + 1):
            for dx in range(-r, r + 1):
                if dx * dx + dy * dy <= r * r:
                    # Simple highlight shading
                    dist = math.sqrt(dx * dx + dy * dy)
                    if dist < r * 0.4:
                        # Highlight center
                        t = dist / (r * 0.4)
                        shade = 1.0 + (1.0 - t) * 0.4
                    else:
                        shade = 1.0 - (dist / r) * 0.3
                    c = (
                        min(255, int(color[0] * shade)),
                        min(255, int(color[1] * shade)),
                        min(255, int(color[2] * shade)),
                    )
                    self.display.set_pixel(icx + dx, icy + dy, c)

    def _draw_bond(self, x1, y1, x2, y2, order):
        """Draw a bond line (single, double, or triple)."""
        ix1, iy1 = int(round(x1)), int(round(y1))
        ix2, iy2 = int(round(x2)), int(round(y2))

        if order == 1:
            self.display.draw_line(ix1, iy1, ix2, iy2, BOND_COLOR)
        elif order >= 2:
            # Compute perpendicular offset for parallel lines
            dx = x2 - x1
            dy = y2 - y1
            length = math.sqrt(dx * dx + dy * dy)
            if length < 0.01:
                return
            # Perpendicular unit vector
            px = -dy / length
            py = dx / length

            if order == 2:
                for offset in (-0.5, 0.5):
                    ox = int(round(px * offset))
                    oy = int(round(py * offset))
                    self.display.draw_line(
                        ix1 + ox, iy1 + oy, ix2 + ox, iy2 + oy, BOND_COLOR
                    )
            else:  # triple
                for offset in (-1, 0, 1):
                    ox = int(round(px * offset))
                    oy = int(round(py * offset))
                    self.display.draw_line(
                        ix1 + ox, iy1 + oy, ix2 + ox, iy2 + oy, BOND_COLOR
                    )
